<!DOCTYPE html><html><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="description">
        <meta name="keywords" content="static content generator,static site generator,static site,HTML,web development,.NET,C#,Razor,Markdown,YAML">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/animancer/assets/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/animancer/assets/img/favicon.ico" type="image/x-icon">
        <title>Animancer - 02 Uneven Ground</title>
        <link href="/animancer/assets/css/highlight.css" rel="stylesheet">
        <link href="/animancer/assets/css/bootstrap/bootstrap.css" rel="stylesheet">
        <link href="/animancer/assets/css/adminlte/AdminLTE.css" rel="stylesheet">
        <link href="/animancer/assets/css/theme/theme.css" rel="stylesheet">
        <link href="//fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:400,400i,700,700i" rel="stylesheet">
        <link href="/animancer/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/animancer/assets/css/override.css" rel="stylesheet">
        <script src="/animancer/assets/js/jquery-2.2.3.min.js"></script>
        <script src="/animancer/assets/js/bootstrap.min.js"></script>        
        <script src="/animancer/assets/js/app.min.js"></script>         
        <script src="/animancer/assets/js/highlight.pack.js"></script>   
        <script src="/animancer/assets/js/jquery.slimscroll.min.js"></script>
        <script src="/animancer/assets/js/jquery.sticky-kit.min.js"></script>
        <script src="/animancer/assets/js/mermaid.min.js"></script>
        <script src="/animancer/assets/js/svg-pan-zoom.min.js"></script>
        <!--[if lt IE 9]>
        <script src="/animancer/assets/js/html5shiv.min.js"></script>
        <script src="/animancer/assets/js/respond.min.js"></script>
        <![endif]-->  

        
    </head>
    <body class="hold-transition wyam layout-boxed  ">    
        <div class="top-banner"></div>
        <div class="wrapper with-container">
            <!-- Header -->
            <header class="main-header">   
                     
                <a href="/animancer/" class="logo">
                            <span>Animancer</span>
                </a>   
                         
                <nav class="navbar navbar-static-top" role="navigation">
                    <!-- Sidebar toggle button-->
                        <a href="#" class="sidebar-toggle visible-xs-block" data-toggle="offcanvas" role="button">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-right"></i>
                        </a>
                                        
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-down"></i>
                        </button>
                    </div>
            
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                        <ul class="nav navbar-nav">                            
                                    <li class="active"><a href="/animancer/docs"><img src="/animancer/images/docs.png" height="20" style="position:relative; left:-5px; top:-1px;"> Docs</a></li>
        <li><a href="/animancer/faq"><img src="/animancer/images/faq.png" height="20" style="position:relative; left:-4px; top:-1px;"> FAQ</a></li>
        <li><a href="/animancer/api/Animancer/AnimancerComponent"><img src="/animancer/images/api.png" height="20" style="position:relative; left:-3px; top:-1px;"> API v3.1</a></li>
        <li><a href="https://forum.unity.com/threads/566452"><img src="/animancer/images/forum.png" height="20" style="position:relative; left:-4px; top:-1px;"> Forum</a></li>
        <li><a href="mailto:AnimancerUnityPlugin@gmail.com?subject=Animancer"><img src="/animancer/images/contact.png" height="20" style="position:relative; left:-4px; top:-1px;"> Contact</a></li>
        <li><a href="http://u3d.as/19Xd"><img src="/animancer/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Try</a></li>
        <li><a href="http://u3d.as/19Xb"><img src="/animancer/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Buy</a></li>
        <li><a href="https://kybernetikgames.github.io/kailas-dierk/unity-assets"><img src="/animancer/images/kybernetik.png" height="20" style="position:relative; left:-2px; top:-1px;"> Other Assets</a></li>
 
                        </ul>       
                    </div>
                    <!-- /.navbar-collapse -->
                
                    <!-- Navbar Right Menu -->
                </nav>
            </header>
            
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="main-sidebar ">
                <section class="infobar" data-spy="affix" data-offset-top="60" data-offset-bottom="200"> 
                    	
    <div id="infobar-headings"><h6>On This Page</h6><p><a href="#ik-curves">IK Curves</a></p>
<p><a href="#raycasting">Raycasting</a></p>
<hr class="infobar-hidden">
</div>

                </section>
                <section class="sidebar">    
                                     
                    

                    <ul class="sidebar-menu">
                        

                <li class="treeview">
                    <a href="/animancer/docs/introduction">Introduction</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/introduction/feature-comparison">Feature Comparison</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/introduction/mecanim-vs-animancer">Mecanim vs. Animancer</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/why-replace-mecanim">Why Replace Mecanim?</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/playing">Playing</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/waiting">Waiting</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/speed-and-time">Speed and Time</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/weapon-animations">Weapon Animations</a></li>
                <li><a href="/animancer/docs/introduction/mecanim-vs-animancer/performance">Performance Benchmarks</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/introduction/glossary">Glossary</a></li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/docs/examples">Examples</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/docs/examples/basics">01 Basics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/basics/basic-scene-setup">Basic Scene Setup</a></li>
                <li><a href="/animancer/docs/examples/basics/simple-playing">01 Simple Playing</a></li>
                <li><a href="/animancer/docs/examples/basics/playing-and-fading">02 Playing and Fading</a></li>
                <li><a href="/animancer/docs/examples/basics/sequence-coroutine">03 Sequence Coroutine</a></li>
                <li><a href="/animancer/docs/examples/basics/named-animations">04 Named Animations</a></li>
                <li><a href="/animancer/docs/examples/basics/hybrid-system">05 Hybrid System</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/fine-control">02 Fine Control</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/fine-control/spider-bot">01 Spider Bot</a></li>
                <li><a href="/animancer/docs/examples/fine-control/doors">02 Doors</a></li>
                <li><a href="/animancer/docs/examples/fine-control/solo-animation">03 Solo Animation</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/locomotion">03 Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/locomotion/walk-and-run">01 Walk and Run</a></li>
                <li><a href="/animancer/docs/examples/locomotion/root-motion">02 Root Motion</a></li>
                <li><a href="/animancer/docs/examples/locomotion/linear-blending">03 Linear Blending</a></li>
                <li><a href="/animancer/docs/examples/locomotion/directional-blending">04 Directional Blending</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/directional-sprites">04 Directional Sprites</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/directional-sprites/basic-movement">01 Basic Movement</a></li>
                <li><a href="/animancer/docs/examples/directional-sprites/character-controller">02 Character Controller</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/animation-events">05 Animation Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/animation-events/simple-and-end-events">01 Simple and End Events</a></li>
                <li><a href="/animancer/docs/examples/animation-events/other-events">02 Other Events</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/state-machines">06 State Machines</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/state-machines/creatures">01 Creatures</a></li>
                <li><a href="/animancer/docs/examples/state-machines/interrupt-management">02 Interrupt Management</a></li>
                <li><a href="/animancer/docs/examples/state-machines/brains">03 Brains</a></li>
                <li><a href="/animancer/docs/examples/state-machines/more-brains">04 More Brains</a></li>
                <li><a href="/animancer/docs/examples/state-machines/platformer">05 Platformer</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/examples/layers">07 Layers</a></li>
                <li class="treeview active">
                    <a href="/animancer/docs/examples/inverse-kinematics">08 Inverse Kinematics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/inverse-kinematics/puppet">01 Puppet</a></li>
                <li class="selected"><a href="/animancer/docs/examples/inverse-kinematics/uneven-ground">02 Uneven Ground</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/animator-controllers">09 Animator Controllers</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/animator-controllers/hybrid">01 Hybrid</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/animator-controllers/3d-game-kit">02 3D Game Kit</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/problems">Problems with the Original</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/respawn">Respawn</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/idle">Idle</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/examples/animator-controllers/3d-game-kit/locomotion">Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/locomotion/movement">Movement</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/locomotion/turning">Turning</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/airborne">Airborne</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/landing">Landing</a></li>
                <li><a href="/animancer/docs/examples/animator-controllers/3d-game-kit/attack">Attack</a></li>

                    </ul>
                </li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/manual">User Manual</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/manual/playing-animations">Playing Animations</a></li>
                <li><a href="/animancer/docs/manual/states">States</a></li>
                <li><a href="/animancer/docs/manual/inspector">Inspector</a></li>
                <li><a href="/animancer/docs/manual/component-types">Component Types</a></li>
                <li class="treeview">
                    <a href="/animancer/docs/manual/blending">Blending</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/manual/blending/fading">Fading</a></li>
                <li><a href="/animancer/docs/manual/blending/layers">Layers</a></li>
                <li><a href="/animancer/docs/manual/blending/mixers">Mixers</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/docs/manual/finite-state-machines">Finite State Machines</a></li>
                <li><a href="/animancer/docs/manual/state-serializables">State Serializables</a></li>
                <li><a href="/animancer/docs/manual/animator-controllers">Animator Controllers</a></li>
                <li><a href="/animancer/docs/manual/animation-events">Animation Events</a></li>
                <li><a href="/animancer/docs/manual/inverse-kinematics">Inverse Kinematics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/bugs">Unity Bugs</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/bugs/inconsistent-timing">Inconsistent Timing</a></li>
                <li><a href="/animancer/docs/bugs/paused-skinned-mesh-update">Paused Skinned Mesh Update</a></li>
                <li><a href="/animancer/docs/bugs/resetting-animated-values">Resetting Animated Values</a></li>
                <li><a href="/animancer/docs/bugs/root-motion-interpolation">Root Motion Interpolation</a></li>
                <li><a href="/animancer/docs/bugs/unused-graph-destroy-warning">Unused Graph Destroy Warning</a></li>
                <li><a href="/animancer/docs/bugs/update-modes">Update Modes</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/source">Source Code</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/source/creating-custom-states">Creating Custom States</a></li>
                <li><a href="/animancer/docs/source/graph-structure">Graph Structure</a></li>
                <li><a href="/animancer/docs/source/asset-sources">Asset Sources</a></li>
                <li><a href="/animancer/docs/source/coding-standard">Coding Standard</a></li>
                <li><a href="/animancer/docs/source/default-script-template">Default Script Template</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/docs/changes">Change Log</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/docs/changes/ideas">Ideas</a></li>
                <li><a href="/animancer/docs/changes/animancer-v4-0">Plans for v4.0</a></li>
                <li><a href="/animancer/docs/changes/animancer-v3-1">Animancer v3.1</a></li>
                <li><a href="/animancer/docs/changes/animancer-v3-0">Animancer v3.0</a></li>
                <li><a href="/animancer/docs/changes/animancer-v2-0">Animancer v2.0</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-3">Animancer v1.3</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-2">Animancer v1.2</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-1">Animancer v1.1</a></li>
                <li><a href="/animancer/docs/changes/animancer-v1-0">Animancer v1.0</a></li>

                    </ul>
                </li>

                    </ul>
                            
                </section>                
            </aside>
            
            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                



		<section class="content-header">
			<h1>02 Uneven Ground</h1>
		</section>
	<section class="content">
		<blockquote class="blockquote">
<p><strong>Location</strong>: <em>Assets/Plugins/Animancer/Examples/08 Inverse Kinematics/02 Uneven Ground</em></p>
<p><strong>Namespace</strong>: <a href="../../../../api/Animancer.Examples.InverseKinematics"><code>Animancer.Examples.InverseKinematics</code></a></p>
</blockquote>
<p>This example demonstrates how you can use Unity's <a href="../../../manual/inverse-kinematics">Inverse Kinematics</a> system to adjust the height of a character's feet according to the terrain they are walking over.</p>
<table class="table">
  <thead><tr>
    <th style="width:50%">IK Disabled</th>
    <th style="width:50%">IK Enabled</th>
  </tr></thead>
  <tbody>
  <tr>
    <td><img src="ik-disabled.gif" class="img-responsive"></td>
    <td><img src="ik-enabled.gif" class="img-responsive"></td>
  </tr>
  <tr>
    <td>Without IK, the character is always walking as if on flat ground. While walking downhill it looks like they are planting their feet in the air and while walking uphill their feet go through the ground.</td>
    <td>With IK, the character adjusts the positioning of their feet as necessary. While walking downhill they stretch out their feet a bit further and while walking uphill they plant their feet a bit higher up than usual.</td>
  </tr>
  </tbody>
</table>
<p>The actual implementation used here is not very good, the point is simply to prove that IK works very similarly in Animancer as it does in Mecanim.</p>
<p></p><details><summary>It uses a simple <code><a href="/animancer/api/Animancer.Examples.InverseKinematics/ObstacleTreadmill">ObstacleTreadmill</a></code> script to create a random series of objects and rearrange them each time the character moves far enough:</summary><p>
</p><pre><code class="language-cs">using System.Collections.Generic;
using UnityEngine;

public sealed class <a href="/animancer/api/Animancer.Examples.InverseKinematics/ObstacleTreadmill">ObstacleTreadmill</a> : MonoBehaviour
{
    [SerializeField] private float _SpawnCount = 10;
    [SerializeField] private Material _ObstacleMaterial;
    [SerializeField] private float _Length;
    [SerializeField] private float _RotationVariance = 45;
    [SerializeField] private float _BaseScale = 1;
    [SerializeField] private float _ScaleVariance = 0.1f;
    [SerializeField] private Transform _Target;

    private readonly List&lt;Transform&gt; Obstacles = new List&lt;Transform&gt;();

    private void Awake()
    {
        // Spawn a bunch of obstacles and randomise their layout.
        for (int i = 0; i &lt; _SpawnCount; i++)
        {
            var obj = GameObject.CreatePrimitive(PrimitiveType.Capsule).transform;
            obj.GetComponent&lt;Renderer&gt;().sharedMaterial = _ObstacleMaterial;
            obj.parent = transform;
            Obstacles.Add(obj);
        }

        ScrambleObjects();
    }

    private void ScrambleObjects()
    {
        // Move and rotate each of the obstacles randomly.
        for (int i = 0; i &lt; Obstacles.Count; i++)
        {
            var obj = Obstacles[i];
            obj.localPosition = new Vector3(UnityEngine.Random.Range(0, _Length), 0, 0);
            obj.localRotation = Quaternion.Euler(90, UnityEngine.Random.Range(-_RotationVariance, _RotationVariance), 0);
            obj.localScale = Vector3.one * (_BaseScale + UnityEngine.Random.Range(-_ScaleVariance, _ScaleVariance));
        }
    }

    private void FixedUpdate()
    {
        // When the target moves too far, teleport them back and randomize the obstacles again.
        var position = _Target.position;
        if (position.x &lt; transform.position.x)
        {
            ScrambleObjects();

            position.x += _Length;

            // Adjust the height to make sure it is above the ground.
            position.y += 5;
            RaycastHit raycastHit;
            if (Physics.Raycast(position, Vector3.down, out raycastHit, 10))
                position = raycastHit.point;

            _Target.position = position;
        }
    }

    [SerializeField]
    private Transform _Ground;

    public float Slope
    {
        get { return _Ground.localEulerAngles.z; }
        set { _Ground.localEulerAngles = new Vector3(0, 0, value); }
    }
}
</code></pre>
<p></p></details><p></p>
<p></p><details><summary>And the main <code><a href="/animancer/api/Animancer.Examples.InverseKinematics/RaycastFootIK">RaycastFootIK</a></code> script looks like this (with the comments removed since we're about to explain how it works):</summary><p>
</p><pre><code class="language-cs">using Animancer;
using UnityEngine;

public sealed class <a href="/animancer/api/Animancer.Examples.InverseKinematics/RaycastFootIK">RaycastFootIK</a> : MonoBehaviour
{
    [SerializeField] private <a href="/animancer/api/Animancer/AnimancerComponent">AnimancerComponent</a> _Animancer;
    [SerializeField] private <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> _LeftFootWeight;
    [SerializeField] private <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> _RightFootWeight;
    [SerializeField] private float _RaycastOriginY = 0.5f;
    [SerializeField] private float _RaycastEndY = -0.1f;

    private Transform _LeftFoot;
    private Transform _RightFoot;

    public bool ApplyAnimatorIK
    {
        get { return _Animancer.GetLayer(0).ApplyAnimatorIK; }
        set { _Animancer.GetLayer(0).ApplyAnimatorIK = value; }
    }

    private void Awake()
    {
        Debug.Assert(_LeftFootWeight.Clip == _RightFootWeight.Clip);
        _Animancer.Play(_LeftFootWeight);

        ApplyAnimatorIK = true;

        _LeftFoot = _Animancer.Animator.GetBoneTransform(HumanBodyBones.LeftFoot);
        _RightFoot = _Animancer.Animator.GetBoneTransform(HumanBodyBones.RightFoot);
    }

    private void OnAnimatorIK(int layerIndex)
    {
        UpdateFootIK(AvatarIKGoal.LeftFoot, _LeftFootWeight, _LeftFoot, _Animancer.Animator.leftFeetBottomHeight);
        UpdateFootIK(AvatarIKGoal.RightFoot, _RightFootWeight, _RightFoot, _Animancer.Animator.rightFeetBottomHeight);
    }

    private void UpdateFootIK(AvatarIKGoal goal, <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> curve, Transform footTransform, float footBottomHeight)
    {
        var weight = curve.Evaluate(_Animancer);
        _Animancer.Animator.SetIKPositionWeight(goal, weight);
        _Animancer.Animator.SetIKRotationWeight(goal, weight);

        if (weight == 0)
            return;

        var position = footTransform.position;
        position.y = transform.position.y + _RaycastOriginY;

        var distance = _RaycastOriginY - _RaycastEndY;

        RaycastHit hit;
        if (Physics.Raycast(position, Vector3.down, out hit, distance))
        {
            position = hit.point;
            position.y += footBottomHeight;
            _Animancer.Animator.SetIKPosition(goal, position);

            var rotation = _Animancer.Animator.GetIKRotation(goal);
            var localUp = rotation * Vector3.up;

            var rotAxis = Vector3.Cross(localUp, hit.normal);
            var angle = Vector3.Angle(localUp, hit.normal);
            rotation = Quaternion.AngleAxis(angle, rotAxis) * rotation;

            _Animancer.Animator.SetIKRotation(goal, rotation);
        }
        else
        {
            position.y -= distance;
            position.y += footBottomHeight;
            _Animancer.Animator.SetIKPosition(goal, position);
        }
    }
}
</code></pre>
<p></p></details><p></p>
<h1 id="ik-curves">IK Curves</h1>
<p>Unlike the <a href="../puppet">Puppet</a> example, we do not want the character's feet to always be exactly at the target point. Instead, we want them to use the animation to lift their feet (0 IK weight) and only use the IK when their feet are actually supposed to be near the ground (1 IK weight). This example uses a copy of the usual <em>Walk</em> animation with two additional <code>AnimationCurves</code> (<em>Left Foot IK</em> and <em>Right Foot IK</em>) which determine how much weight we want the IK to have at any given point in the animation.</p>
<p>As explained on the <a href="../../../manual/inverse-kinematics#exposed-curves">Inverse Kinematics</a> page, the Playables API does not provide Animancer with a proper way of accessing such curves at runtime so we use <code><a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a></code>s to extract the curves from the clip in the Unity Editor and serialize them separately. So we have two <code><a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a></code>s which we reference in the script:</p>
<pre><code class="language-cs">[SerializeField] private <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> _LeftFootWeight;
[SerializeField] private <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> _RightFootWeight;
</code></pre>
<p>On startup we make sure that they both use the same <code>AnimationClip</code> and play it. Note that <code><a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a></code> has an implicit cast to use its <code>Clip</code> so we don't need to specify it manually when passing it into the <code>Play</code> method.</p>
<pre><code class="language-cs">private Transform _LeftFoot;
private Transform _RightFoot;

private void Awake()
{
    Debug.Assert(_LeftFootWeight.Clip == _RightFootWeight.Clip);
    _Animancer.Play(_LeftFootWeight);
</code></pre>
<p>We also need to enable IK and get the foot bones from the <code>Animator</code> and store them so we don't have to get them again every frame:</p>
<pre><code class="language-cs">public bool ApplyAnimatorIK
{
    get { return _Animancer.GetLayer(0).ApplyAnimatorIK; }
    set { _Animancer.GetLayer(0).ApplyAnimatorIK = value; }
}

private void Awake()
{
    ...

    ApplyAnimatorIK = true;

    _LeftFoot = _Animancer.Animator.GetBoneTransform(HumanBodyBones.LeftFoot);
    _RightFoot = _Animancer.Animator.GetBoneTransform(HumanBodyBones.RightFoot);
}
</code></pre>
<p>Then in <code>OnAnimatorIK</code> we simply evaluate those curves:</p>
<pre><code class="language-cs">private void OnAnimatorIK(int layerIndex)
{
    UpdateFootIK(AvatarIKGoal.LeftFoot, _LeftFootWeight, _LeftFoot, _Animancer.Animator.leftFeetBottomHeight);
    UpdateFootIK(AvatarIKGoal.RightFoot, _RightFootWeight, _RightFoot, _Animancer.Animator.rightFeetBottomHeight);
}

private void UpdateFootIK(AvatarIKGoal goal, <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> curve, Transform footTransform, float footBottomHeight)
{
    var weight = curve.Evaluate(_Animancer);
    _Animancer.Animator.SetIKPositionWeight(goal, weight);
    _Animancer.Animator.SetIKRotationWeight(goal, weight);

    // TODO: set the actual IK position and rotation.
}
</code></pre>
<h1 id="raycasting">Raycasting</h1>
<p>We use the <code>footTransform</code>s to determine where to start each ray with some additional fields to offset the origin above the current position and set the distance to go a bit lower than the original position. Starting too high would allow it to hit objects above the character's legs and allowing the distance to be too large would attempt to stretch their legs further than a person naturally would if the ground is too far away.</p>
<pre><code class="language-cs">[SerializeField] private float _RaycastOriginY = 0.5f;
[SerializeField] private float _RaycastEndY = -0.1f;

private void UpdateFootIK(AvatarIKGoal goal, <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> curve, Transform footTransform, float footBottomHeight)
{
    var weight = curve.Evaluate(_Animancer);
    _Animancer.Animator.SetIKPositionWeight(goal, weight);
    _Animancer.Animator.SetIKRotationWeight(goal, weight);

    if (weight == 0)
        return;

    var position = footTransform.position;
    position.y = transform.position.y + _RaycastOriginY;

    var distance = _RaycastOriginY - _RaycastEndY;
</code></pre>
<p>Then we do a raycast downwards from that point. If it hits something, we use the <code>RaycastHit.point</code> and the <code>footBottomHeight</code> (the distance from the transform to the bottom of the foot model calculated by Unity) to determine the desired position for that foot and the <code>RaycastHit.normal</code> to determine the desired rotation:</p>
<pre><code class="language-cs">RaycastHit hit;
if (Physics.Raycast(position, Vector3.down, out hit, distance))
{
    position = hit.point;
    position.y += footBottomHeight;
    _Animancer.Animator.SetIKPosition(goal, position);

    var rotation = _Animancer.Animator.GetIKRotation(goal);
    var localUp = rotation * Vector3.up;

    var rotAxis = Vector3.Cross(localUp, hit.normal);
    var angle = Vector3.Angle(localUp, hit.normal);
    rotation = Quaternion.AngleAxis(angle, rotAxis) * rotation;

    _Animancer.Animator.SetIKRotation(goal, rotation);
}
</code></pre>
<p>Otherwise if nothing was hit, we simply stretch the leg out to the end of the ray:</p>
<pre><code class="language-cs">else
{
    position.y -= distance;
    position.y += footBottomHeight;
    _Animancer.Animator.SetIKPosition(goal, position);
}
</code></pre>
<p></p><details><summary>The full <code><a href="/animancer/api/Animancer.Examples.InverseKinematics/RaycastFootIK">RaycastFootIK</a></code> script looks like this:</summary><p>
</p><pre><code class="language-cs">using Animancer;
using UnityEngine;

public sealed class <a href="/animancer/api/Animancer.Examples.InverseKinematics/RaycastFootIK">RaycastFootIK</a> : MonoBehaviour
{
    [SerializeField] private <a href="/animancer/api/Animancer/AnimancerComponent">AnimancerComponent</a> _Animancer;
    [SerializeField] private <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> _LeftFootWeight;
    [SerializeField] private <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> _RightFootWeight;
    [SerializeField] private float _RaycastOriginY = 0.5f;
    [SerializeField] private float _RaycastEndY = -0.1f;

    private Transform _LeftFoot;
    private Transform _RightFoot;

    public bool ApplyAnimatorIK
    {
        get { return _Animancer.GetLayer(0).ApplyAnimatorIK; }
        set { _Animancer.GetLayer(0).ApplyAnimatorIK = value; }
    }

    private void Awake()
    {
        Debug.Assert(_LeftFootWeight.Clip == _RightFootWeight.Clip);
        _Animancer.Play(_LeftFootWeight);

        ApplyAnimatorIK = true;

        _LeftFoot = _Animancer.Animator.GetBoneTransform(HumanBodyBones.LeftFoot);
        _RightFoot = _Animancer.Animator.GetBoneTransform(HumanBodyBones.RightFoot);
    }

    private void OnAnimatorIK(int layerIndex)
    {
        UpdateFootIK(AvatarIKGoal.LeftFoot, _LeftFootWeight, _LeftFoot, _Animancer.Animator.leftFeetBottomHeight);
        UpdateFootIK(AvatarIKGoal.RightFoot, _RightFootWeight, _RightFoot, _Animancer.Animator.rightFeetBottomHeight);
    }

    private void UpdateFootIK(AvatarIKGoal goal, <a href="/animancer/api/Animancer/ExposedCurve">ExposedCurve</a> curve, Transform footTransform, float footBottomHeight)
    {
        var weight = curve.Evaluate(_Animancer);
        _Animancer.Animator.SetIKPositionWeight(goal, weight);
        _Animancer.Animator.SetIKRotationWeight(goal, weight);

        if (weight == 0)
            return;

        var position = footTransform.position;
        position.y = transform.position.y + _RaycastOriginY;

        var distance = _RaycastOriginY - _RaycastEndY;

        RaycastHit hit;
        if (Physics.Raycast(position, Vector3.down, out hit, distance))
        {
            position = hit.point;
            position.y += footBottomHeight;
            _Animancer.Animator.SetIKPosition(goal, position);

            var rotation = _Animancer.Animator.GetIKRotation(goal);
            var localUp = rotation * Vector3.up;

            var rotAxis = Vector3.Cross(localUp, hit.normal);
            var angle = Vector3.Angle(localUp, hit.normal);
            rotation = Quaternion.AngleAxis(angle, rotAxis) * rotation;

            _Animancer.Animator.SetIKRotation(goal, rotation);
        }
        else
        {
            position.y -= distance;
            position.y += footBottomHeight;
            _Animancer.Animator.SetIKPosition(goal, position);
        }
    }
}
</code></pre>
<p></p></details><p></p>
<p>Now we have a character that looks slightly more realistic when walking on uneven ground and slopes:</p>
<table class="table">
  <thead><tr>
    <th style="width:50%">IK Disabled</th>
    <th style="width:50%">IK Enabled</th>
  </tr></thead>
  <tbody>
  <tr>
    <td><img src="ik-disabled.gif" class="img-responsive"></td>
    <td><img src="ik-enabled.gif" class="img-responsive"></td>
  </tr>
  </tbody>
</table>

	</section>
                
            </div>           
            
            <!-- Footer -->
            <footer class="main-footer">
            </footer>
            
        </div>
        <div class="wrapper bottom-wrapper">
            <footer class="bottom-footer">
                Generated by <a href="https://wyam.io">Wyam</a>
            </footer>
        </div>
        <a href="javascript:" id="return-to-top"><i class="fa fa-chevron-up"></i></a>
        
        <script>           
            // Close the sidebar if we select an anchor link
            $(".main-sidebar a[href^='#']:not('.expand')").click(function(){
                $(document.body).removeClass('sidebar-open');
            });
            
            $(document).ready(function() {
                mermaid.initialize(
                {
                    flowchart:
                    {
                        useMaxWidth: false
                    },
					startOnLoad: false,
					cloneCssStyles: false
                });     
                mermaid.init(undefined, ".mermaid");

                // Remove the max-width setting that Mermaid sets
                var mermaidSvg = $('.mermaid svg');
                mermaidSvg.addClass('img-responsive');
                mermaidSvg.css('max-width', '');

                // Make it scrollable
				var target = document.querySelector(".mermaid svg");
				if(target !== null)
				{
					var panZoom = window.panZoom = svgPanZoom(target, {
						zoomEnabled: true,
						controlIconsEnabled: true,
						fit: true,
						center: true,
                        maxZoom: 20,
                        zoomScaleSensitivity: 0.6
					});			                          

                    // Do the reset once right away to fit the diagram
                    panZoom.resize();
                    panZoom.fit();
                    panZoom.center();
                    
                    $(window).resize(function(){
                        panZoom.resize();
                        panZoom.fit();
                        panZoom.center();
                    });
				}
                
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                });  
            });

            hljs.initHighlightingOnLoad();

            // Back to top
            $(window).scroll(function() {
                if ($(this).scrollTop() >= 200) {        // If page is scrolled more than 50px
                    $('#return-to-top').fadeIn(1000);    // Fade in the arrow
                } else {
                    $('#return-to-top').fadeOut(1000);   // Else fade out the arrow
                }
            });
            $('#return-to-top').click(function() {      // When arrow is clicked
                $('body,html').animate({
                    scrollTop : 0                       // Scroll to top of body
                }, 500);
            });
        </script>
    
</body></html>