<!DOCTYPE html><html><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="description">
        <meta name="keywords" content="static content generator,static site generator,static site,HTML,web development,.NET,C#,Razor,Markdown,YAML">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <title>Animancer - Attack</title>
        <link href="/animancer/v4-0/assets/css/highlight.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/bootstrap/bootstrap.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/adminlte/AdminLTE.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/theme/theme.css" rel="stylesheet">
        <link href="//fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:400,400i,700,700i" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/animancer/v4-0/assets/css/override.css" rel="stylesheet">
        <script src="/animancer/v4-0/assets/js/jquery-2.2.3.min.js"></script>
        <script src="/animancer/v4-0/assets/js/bootstrap.min.js"></script>        
        <script src="/animancer/v4-0/assets/js/app.min.js"></script>         
        <script src="/animancer/v4-0/assets/js/highlight.pack.js"></script>   
        <script src="/animancer/v4-0/assets/js/jquery.slimscroll.min.js"></script>
        <script src="/animancer/v4-0/assets/js/jquery.sticky-kit.min.js"></script>
        <script src="/animancer/v4-0/assets/js/mermaid.min.js"></script>
        <script src="/animancer/v4-0/assets/js/svg-pan-zoom.min.js"></script>
        <!--[if lt IE 9]>
        <script src="/animancer/v4-0/assets/js/html5shiv.min.js"></script>
        <script src="/animancer/v4-0/assets/js/respond.min.js"></script>
        <![endif]-->  

        
    </head>
    <body class="hold-transition wyam layout-boxed  ">    
        <div class="top-banner"></div>
        <div class="wrapper with-container">
            <!-- Header -->
            <header class="main-header">   
                     
                <a href="/animancer/v4-0/" class="logo">
                            <span>Animancer</span>
                </a>   
                         
                <nav class="navbar navbar-static-top" role="navigation">
                    <!-- Sidebar toggle button-->
                        <a href="#" class="sidebar-toggle visible-xs-block" data-toggle="offcanvas" role="button">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-right"></i>
                        </a>
                                        
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-down"></i>
                        </button>
                    </div>
            
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                        <ul class="nav navbar-nav">                            
                                    <li class="active"><a href="/animancer/v4-0/docs"><img src="/animancer/v4-0/images/docs.png" height="20" style="position:relative; left:-5px; top:-1px;"> Docs</a></li>
        <li><a href="/animancer/v4-0/docs/help"><img src="/animancer/v4-0/images/help.png" height="20" style="position:relative; left:-4px; top:-1px;"> Help</a></li>
        <li><a href="/animancer/v4-0/api/Animancer/AnimancerComponent"><img src="/animancer/v4-0/images/api.png" height="20" style="position:relative; left:-3px; top:-1px;"> API v4.0</a></li>
        <li><a href="/animancer/lite"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Try</a></li>
        <li><a href="/animancer/pro"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Buy</a></li>
        <li><a href="https://kybernetikgames.github.io/kailas-dierk/unity-assets"><img src="/animancer/v4-0/images/kybernetik.png" height="20" style="position:relative; left:-2px; top:-1px;"> Other Assets</a></li>
 
                        </ul>       
                    </div>
                    <!-- /.navbar-collapse -->
                
                    <!-- Navbar Right Menu -->
                </nav>
<a href="/animancer" style="font-size:1.42em; color:white">This is the <strong>Animancer v4.0 Beta</strong> Documentation. Click Here to return to the v3.1 Documentation.</a>
            </header>
            
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="main-sidebar ">
                <section class="infobar" data-spy="affix" data-offset-top="60" data-offset-bottom="200"> 
                    	
    <div id="infobar-headings"><h6>On This Page</h6><p><a href="#original">Original</a></p>
<p><a href="#animancer">Animancer</a></p>
<p><a href="#buffered-input">Buffered Input</a></p>
<p><a href="#attack-details">Attack Details</a></p>
<p><a href="#fields">Fields</a></p>
<p><a href="#state-entry">State Entry</a></p>
<p><a href="#updates">Updates</a></p>
<p><a href="#adding-more-attacks">Adding More Attacks</a></p>
<hr class="infobar-hidden">
</div>

                </section>
                <section class="sidebar">    
                                     
                    

                    <ul class="sidebar-menu">
                        

                <li><a href="/animancer/v4-0/docs/help">Help and FAQ</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction">Introduction</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer">Mecanim vs. Animancer</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/why-replace-mecanim">Why Replace Mecanim?</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/playing">Playing</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/waiting">Waiting</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/speed-and-time">Speed and Time</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/weapon-animations">Weapon Animations</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/performance">Performance</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/introduction/features">Features</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/glossary">Glossary</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/cs">C# in Unity</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/cs/overview">Scripting Overview</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/organisation">Organisation</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/variables">Variables</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/methods">Methods</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/inheritance">Inheritance</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/vectors">Vectors</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/other">Other Topics</a></li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples">Examples</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/basics">01 Basics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/basics/scene-setup">Basic Scene Setup</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/quick-play">01 Quick Play</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/playing-and-fading">02 Playing and Fading</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/sequence-coroutine">03 Sequence Coroutine</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/named-animations">04 Named Animations</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/hybrid">05 Hybrid Basics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/fine-control">02 Fine Control</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/fine-control/spider-bot">01 Spider Bot</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/doors">02 Doors</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/solo-animation">03 Solo Animation</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/locomotion">03 Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/locomotion/walk-and-run">01 Walk and Run</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/root-motion">02 Root Motion</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/linear-blending">03 Linear Blending</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/directional-blending">04 Directional Blending</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/directional-sprites">04 Directional Sprites</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/basic-movement">01 Basic Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/character-controller">02 Character Controller</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animation-events">05 Animation Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animation-events/simple-and-end-events">01 Simple and End Events</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animation-events/other-events">02 Other Events</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/state-machines">06 State Machines</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/state-machines/creatures">01 Creatures</a></li>
                <li><a href="/animancer/v4-0/docs/examples/state-machines/interrupt-management">02 Interrupt Management</a></li>
                <li><a href="/animancer/v4-0/docs/examples/state-machines/brains">03 Brains</a></li>
                <li><a href="/animancer/v4-0/docs/examples/state-machines/more-brains">04 More Brains</a></li>
                <li><a href="/animancer/v4-0/docs/examples/state-machines/platformer">05 Platformer</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/examples/layers">07 Layers</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/inverse-kinematics">08 Inverse Kinematics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/inverse-kinematics/puppet">01 Puppet</a></li>
                <li><a href="/animancer/v4-0/docs/examples/inverse-kinematics/uneven-ground">02 Uneven Ground</a></li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers">09 Animator Controllers</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/hybrid">01 Hybrid</a></li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit">02 3D Game Kit</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/problems">Problems with the Original</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/respawn">Respawn</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/idle">Idle</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion">Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/movement">Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/turning">Turning</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/airborne">Airborne</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/landing">Landing</a></li>
                <li class="selected"><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/attack">Attack</a></li>

                    </ul>
                </li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual">User Manual</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/playing">Playing Animations</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/playing/states">States</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/inspector">Inspector</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/component-types">Component Types</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/directional-sets">Directional Animation Sets</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/transitions">Transitions</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/transitions/types">Transition Types</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/blending">Blending</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/blending/fading">Fading</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/layers">Layers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/mixers">Mixers</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/events">Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/events/animation">Animation Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/animancer">Animancer Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/end">End Events</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/manual/finite-state-machines">Finite State Machines</a></li>
                <li><a href="/animancer/v4-0/docs/manual/animator-controllers">Animator Controllers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/inverse-kinematics">Inverse Kinematics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/bugs">Unity Bugs</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/bugs/inconsistent-timing">Inconsistent Timing</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/paused-skinned-mesh-update">Paused Skinned Mesh Update</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/resetting-animated-values">Resetting Animated Values</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/unused-graph-destroy-warning">Unused Graph Destroy Warning</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/update-modes">Update Modes</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/source">Source Code</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/source/dlls">DLLs</a></li>
                <li><a href="/animancer/v4-0/docs/source/creating-custom-states">Creating Custom States</a></li>
                <li><a href="/animancer/v4-0/docs/source/graph-structure">Graph Structure</a></li>
                <li><a href="/animancer/v4-0/docs/source/asset-sources">Asset Sources</a></li>
                <li><a href="/animancer/v4-0/docs/source/coding-standard">Coding Standard</a></li>
                <li><a href="/animancer/v4-0/docs/source/default-script-template">Default Script Template</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/changes">Change Log</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0-beta">Beta Test v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0">Progress of v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-1">Animancer v3.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-0">Animancer v3.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v2-0">Animancer v2.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-3">Animancer v1.3</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-2">Animancer v1.2</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-1">Animancer v1.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-0">Animancer v1.0</a></li>

                    </ul>
                </li>

                    </ul>
                            
                </section>                
            </aside>
            
            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                



		<section class="content-header">
			<h1>Attack</h1>
		</section>
	<section class="content">
		<blockquote class="blockquote">
<p>This page is part of the <a href="../">3D Game Kit</a> example.</p>
</blockquote>
<p>Most combat games feature attack combos where performing multiple attacks in quick succession will use various different animations in a sequence which resets to the beginning if you stop attacking or reach the end, which is what we have here:</p>
<p><img src="combo.gif" class="img-responsive"></p>
<h1 id="original">Original</h1>
<p>The original character's <code>MeleeCombatSM</code> state is a <a href="https://docs.unity3d.com/Manual/NestedStateMachines.html">Sub State Machine</a> containing several <em>Attack</em> animations:</p>
<p><img src="attack-sub-state.png" class="img-responsive"></p>
<p>At first glance, the general concept is easy to understand - it will start with the first <em>Attack</em> animation (<code>EllenCombo1</code>) and continue to each of the others in order if you keep trying to attack - but as usual, the specific implementation of that logic is scattered all over the place:</p>
<ol>
<li><code>PlayerInput.Update</code> checks for the attack input in order to start the <code>AttackWait</code> coroutine.</li>
<li><code>AttackWait</code> sets <code>m_Attack = true;</code> then waits for 0.03 seconds, then sets it back to <code>false</code>. This is a dirty hack to ensure that the input doesn't get missed in case there are multiple <code>Update</code>s in a row without a <code>FixedUpdate</code> between them, but otherwise it's an arbitrary amount of time which is too small to have any other use.</li>
<li><code>PlayerController.FixedUpdate</code> resets the <code>MeleeAttack</code> trigger in the Animator Controller every frame and then sets it if the above input was detected. This means it should just be a bool parameter since the features of a trigger aren't even being used.</li>
<li><code>FixedUpdate</code> also gets the normalized time of the current state from the Animator Controller and sends it back into the <code>StateTime</code> parameter.</li>
<li>The Animator Controller uses the <code>MeleeAttack</code> trigger to transition into the <code>MeleeCombatSM</code> sub state machine and play the first attack animation (<code>EllenCombo1</code>).</li>
<li><code>FixedUpdate</code> also calls <code>SetTargetRotation</code> which checks <code>if (m_InAttack)</code> in order to turn the player towards a nearby enemy if there is one.</li>
<li>Searching for references to <code>m_InAttack</code> finds that the only place it gets set to true is the <code>MeleeAttackStart</code> method which has a comment explaining that it is called by an <a href="../../../../manual/animation-events">Animation Event</a>.</li>
<li><code>FixedUpdate</code> also calls <code>PlayAudio</code> which plays a sound if one of the attack states was just entered. This is another dirty hack because it does so by checking each of the individual state names (<code>EllenCombo1</code>, <code>EllenCombo2</code>, etc.).</li>
<li>Each of the <code>EllenCombo</code> states has a <code>StateMachineBehaviour</code> called <code>EllenStaffEffect</code> with an <code>int effectIndex</code> which is set in the Inspector. When a state is entered its <code>OnStateEnter</code> method gets the <code>PlayerController</code> and accesses the effect of their weapon at the specified index in order to call <code>TimeEffect.Activate</code> on it.</li>
<li>That method activates an animated weapon trail and a <code>Light</code>, then uses a coroutine to wait until the animation finishes to deactivate it.</li>
<li>Each of the <code>EllenCombo</code> states has various transitions, including one which leads to the next state in the sequence on the conditions that <code>MeleeAttack</code> is true (meaning the player is trying to attack) and the <code>StateTime</code> (from step #4) is within a certain range.</li>
</ol>
<p><img src="attack-transition.png" class="img-responsive"></p>
<p>Note how several of those steps so not directly lead into the next. <code>PlayerInput</code> doesn't just call a method which you can read to in order to find out what it does, instead it sets a value and you need to check everywhere that references that value to find out what effect it will have. This is a big part of what makes the setup so convoluted.</p>
<h1 id="animancer">Animancer</h1>
<p></p><details><summary>The Animancer character handles all the above logic in the <code>AttackState</code> script which makes the flow of logic far easier to understand:</summary><p>
</p><pre><code class="language-cs">using Animancer;
using Animancer.FSM;
using System;
using UnityEngine;

public sealed class AttackState : CreatureState
{
    [Serializable]
    public class AttackClip : <a href="/animancer/v4-0/api/Animancer/Transition">ClipState.Transition</a>
    {
        [SerializeField]
        [Tooltip("The normalized time when this attack will begin transitioning back to idle")]
        [Range(0, 1)]
        private float _EndNormalizedTime = 0.75f;

        public float EndNormalizedTime
        {
            get { return _EndNormalizedTime; }
        }

        [SerializeField]
        private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/AttackTrail">AttackTrail</a> _Trail;

        public override void Apply(AnimancerState state)
        {
            base.Apply(state);
            _Trail.Activate();
        }
    }

    [SerializeField] private float _TurnSpeed = 400;
    [SerializeField] private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/RandomAudioPlayer">RandomAudioPlayer</a> _WeaponAudio;
    [SerializeField] private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/RandomAudioPlayer">RandomAudioPlayer</a> _EmoteAudio;
    [SerializeField] private AttackClip[] _Animations;

    private int _AttackIndex = int.MaxValue;
    private AttackClip _Attack;

    public override bool CanEnterState(CreatureState previousState)
    {
        return Creature.CharacterController.isGrounded;
    }

    private void OnEnable()
    {
        if (_AttackIndex &gt;= _Animations.Length - 1 ||
            _Animations[_AttackIndex].State.Weight == 0)
        {
            _AttackIndex = 0;
        }
        else
        {
            _AttackIndex++;
        }

        _Attack = _Animations[_AttackIndex];
        Animancer.Transition(_Attack);
        _WeaponAudio.PlayRandomClip();
        _EmoteAudio.PlayRandomClip();
        <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/224320DD">Creature.ForwardSpeed</a> = 0;
    }

    public override bool FullMovementControl { get { return false; } }

    private void FixedUpdate()
    {
        if (Creature.CheckMotionState())
            return;

        Creature.TurnTowards(Creature.Brain.Movement, _TurnSpeed);
    }

    public override bool CanExitState(CreatureState nextState)
    {
        return _Attack.State.NormalizedTime &gt;= _Attack.EndNormalizedTime;
    }
}
</code></pre>
<p></p></details><p></p>
<p>Well, not quite <em>all</em> the logic:</p>
<h1 id="buffered-input">Buffered Input</h1>
<p>The initial input check is handled by the <code><a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/KeyboardAndMouseBrain">KeyboardAndMouseBrain</a></code> script.</p>
<p>It starts with a reference to the <em>Attack</em> state which is assigned in the Inspector.</p>
<pre><code class="language-cs">[SerializeField] private CreatureState _Attack;
</code></pre>
<p>Note that this is the only place where the <em>Attack</em> state is actually referenced. The <code>Creature</code> script has references to the core states - <em>Respawn</em>, <em>Idle</em>, <em>Locomotion</em>, and <em>Airborne</em> - but none of them know anything about the ability to attack.</p>
<p>In the original character (step #11 above), each attack had a window of time during which you could press the attack button to perform the next attack in the combo. These windows were defined in the transition conditions which made them tricky to work with for two main reasons:</p>
<ul>
<li>You can't view more than one at a time and it takes two clicks to swap between them.</li>
<li>Since the <code>StateTime</code> parameter is actually set using the state's normalized time, it's hard to judge how much time a particular value actually represents.</li>
</ul>
<p>Instead of trying to replicate that setup, the Animancer character instead uses a concept known as <em>input buffering</em> which simply means that if a button press fails to trigger the desired action, it will still be able to do so for a short time afterwards. Fortunately, Animancer's <a href="../../../manual/finite-state-machines#input-buffers">Finite State Machine</a> system has an <code>InputBuffer</code> class which is very easy to use. So we make a time out field to determine how long the buffer will last and initialise it with the <code>StateMachine</code> it will be buffering:</p>
<pre><code>[SerializeField] private float _AttackInputTimeOut = 0.5f;

private StateMachine&lt;CreatureState&gt;.InputBuffer _InputBuffer;

private void Awake()
{
    _InputBuffer = new StateMachine&lt;CreatureState&gt;.InputBuffer(Creature.StateMachine);
}
</code></pre>
<p>Then when we detect the <em>Attack</em> button being pressed and would normally call <code>Creature.StateMachine.TrySetState(_Attack)</code> we instead call a similar method on the <code>InputBuffer</code> where we also specify the time out duration:</p>
<pre><code class="language-cs">private void Update()
{
    ...

    if (Input.GetButtonDown("Fire1"))
    {
        _InputBuffer.TrySetState(_Attack, _AttackInputTimeOut);
    }
</code></pre>
<p>And on any <code>Update</code> where we didn't just attempt a new action, we update the buffer to give it another chance to retry a previously buffered action and check if it has timed out:</p>
<pre><code class="language-cs">    else
    {
        _InputBuffer.Update();
    }
}
</code></pre>
<p>Using the same 0.5 second window for every attack gives much more consistent gameplay where the player can get a feel for when they will need to press the button rather than arbitrarily varying it for every attack.</p>
<h1 id="attack-details">Attack Details</h1>
<p>Now that we've taken care of getting into the <code>AttackState</code>, we want to make an array of <code>AnimationClip</code>s with some additional details such as transition timings. This is what <a href="../../../../manual/transitions">Transitions</a> like <code><a href="/animancer/v4-0/api/Animancer/Transition">ClipState.Transition</a></code> are good for, but we want a few more details so we declare a class that inherits from it:</p>
<pre><code class="language-cs">[Serializable]
public class AttackClip : <a href="/animancer/v4-0/api/Animancer/Transition">ClipState.Transition</a>
{
</code></pre>
<p>The first thing we want is a value to determine when we want the animation to end:</p>
<pre><code class="language-cs">    [SerializeField]
    [Tooltip("The normalized time when this attack will begin transitioning back to idle")]
    [Range(0, 1)]
    private float _EndNormalizedTime = 0.75f;

    public float EndNormalizedTime
    {
        get { return _EndNormalizedTime; }
    }
</code></pre>
<p>We also want an <code><a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/AttackTrail">AttackTrail</a></code>, which is the visual light trail effect that appears when swinging the weapon</p>
<pre><code class="language-cs">    [SerializeField]
    private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/AttackTrail">AttackTrail</a> _Trail;
</code></pre>
<p>Rather than exposing it publicly for the <code>AttackState</code> to activate when it plays this attack, we can override the <code>Apply</code> method to handle that responsibility internally:</p>
<pre><code class="language-cs">    public override void Apply(AnimancerState state)
    {
        base.Apply(state);
        _Trail.Activate();
    }
}
</code></pre>
<p>If we wanted the ability to tweak the speed of the attack animation, we would also need to pass that speed onto the trail so it gets shown correctly in relation to the character.</p>
<p></p><details><summary>The <code><a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/AttackTrail">AttackTrail</a></code> script is a cleaned up copy of the <code>TimeEffect</code> script used by the original character (renamed because the original name was misleading, though there might still be a better possibility):</summary><p>
</p><pre><code class="language-cs">using System.Collections;
using UnityEngine;

public sealed class <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/AttackTrail">AttackTrail</a> : MonoBehaviour
{
    [SerializeField] private Light _Light;
    [SerializeField] private Animation _Animation;

#if UNITY_EDITOR
    private void Reset()
    {
        _Light = Editor.AnimancerEditorUtilities.GetComponentInHierarchy&lt;Light&gt;(gameObject);
        _Animation = Editor.AnimancerEditorUtilities.GetComponentInHierarchy&lt;Animation&gt;(gameObject);
        gameObject.SetActive(false);
    }
#endif

    public void Activate()
    {
        gameObject.SetActive(true);
        _Light.enabled = true;

        _Animation.Play();

        StartCoroutine(DisableAtEndOfAnimation());
    }

    private IEnumerator DisableAtEndOfAnimation()
    {
        yield return new WaitForSeconds(_Animation.clip.length);

        gameObject.SetActive(false);
        _Light.enabled = false;
    }
}
</code></pre>
<p></p></details><p></p>
<h1 id="fields">Fields</h1>
<p>Now that we have made the <code>AttackClip</code> class to encapsulate the details we want, we can make some serialized fields to show in the Inspector:</p>
<pre><code class="language-cs">[SerializeField] private float _TurnSpeed = 400;
[SerializeField] private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/RandomAudioPlayer">RandomAudioPlayer</a> _WeaponAudio;
[SerializeField] private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/RandomAudioPlayer">RandomAudioPlayer</a> _EmoteAudio;
[SerializeField] private AttackClip[] _Animations;
</code></pre>
<p>Logically, the <code>_Animations</code> array should probably be first because it gets used first and is most important, however putting the unique fields first instead makes the Inspector a bit easier to read.</p>
<p>We also need some non-serialized fields to remember the index of the current attack (to play the next one in the sequence when the player attacks repeatedly) and keep a direct reference to that attack for use later on:</p>
<pre><code class="language-cs">private int _AttackIndex = int.MaxValue;
private AttackClip _Attack;
</code></pre>
<h1 id="state-entry">State Entry</h1>
<p>Note how we initialise the index to start at <code>int.MaxValue</code> so that the first condition checked by <code>OnEnable</code> is true the first time it is used (see below).</p>
<p>In this example, we only allow attacking while grounded:</p>
<pre><code class="language-cs">public override bool CanEnterState(CreatureState previousState)
{
    return Creature.CharacterController.isGrounded;
}
</code></pre>
<p>Plenty of other games have airborne attacks as well, which could be achieved by giving this state an Inspector <code>bool</code> to determine whether it is for ground or air attacks, or by giving it a second array of <code>AttackClip</code>s to use when airborne.</p>
<p>When entering this state, we start by determining which attack in the sequence we are up to. If the previous attack was the last one or it has already fully faded out, we want the first attack, but otherwise we can go to the next one in line:</p>
<pre><code class="language-cs">private void OnEnable()
{
    if (_AttackIndex &gt;= _Animations.Length - 1 ||
        _Animations[_AttackIndex].State.Weight == 0)
    {
        _AttackIndex = 0;
    }
    else
    {
        _AttackIndex++;
    }
</code></pre>
<p>Now that the attack has been chosen, we can play it along with some sounds (<code>_WeaponAudio</code> is the physical sword swing while <code>_EmoteAudio</code> is the vocal grunt) and cancel out the character's forward speed:</p>
<pre><code class="language-cs">    _Attack = _Animations[_AttackIndex];
    Animancer.Transition(_Attack);
    _WeaponAudio.PlayRandomClip();
    _EmoteAudio.PlayRandomClip();
    <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/224320DD">Creature.ForwardSpeed</a> = 0;
}
</code></pre>
<h1 id="updates">Updates</h1>
<p>While this state is active, we want to apply the raw root motion from the attack animations so we disable <code>FullMovementControl</code>:</p>
<pre><code class="language-cs">public override bool FullMovementControl { get { return false; } }
</code></pre>
<p>This <code>FixedUpdate</code> method is the simplest of any state, we just <a href="../idle#check-motion-state">Check the standard transitions</a> (<em>Idle</em>, <em>Locomotion</em>, or <em>Airborne</em> as appropriate) and turn in the direction the <code>Creature.Brain</code> wants to go:</p>
<pre><code class="language-cs">private void FixedUpdate()
{
    if (Creature.CheckMotionState())
        return;

    Creature.TurnTowards(Creature.Brain.Movement, _TurnSpeed);
}
</code></pre>
<p>On its own, <code>CheckMotionState</code> would immediately go to a different state, however we want to prevent other actions from interrupting attacks until they are done so we override <code>CanExitState</code> to base its answer on the time of the current attack:</p>
<pre><code class="language-cs">public override bool CanExitState(CreatureState nextState)
{
    return _Attack.State.NormalizedTime &gt;= _Attack.EndNormalizedTime;
}
</code></pre>
<p>This means that once the specified time passes, the next <code>FixedUpdate</code> will change to one of the standard states (and that state will be responsible for fading in its own animation). If the <a href="#input-buffer">Input Buffer</a> is attempting to attack again, it will then do so next time it is updated, which will enter this state again. Since the attack animation that just ended would still be fading out at that point, the <code>OnEnable</code> method would then move it onto the next attack in the sequence.</p>
<p>If we had states like <em>Hurt</em> and <em>Dead</em>, we could use the ideas covered in the <a href="../../../state-machines/interrupt-management">Interrupt Management</a> example to allow them to interrupt this state regardless of the time.</p>
<h1 id="adding-more-attacks">Adding More Attacks</h1>
<p>Much like if we want to <a href="../idle#adding-more-idles">add more idle animations</a>, building this state to use an array makes it much easier to modify the general behaviour and set up any number of animations without needing to set up the same states, transitions, and <code>StateMachineBehaviour</code>s every time.</p>

	</section>
                
            </div>           
            
            <!-- Footer -->
            <footer class="main-footer">
            </footer>
            
        </div>
        <div class="wrapper bottom-wrapper">
            <footer class="bottom-footer">
                Generated by <a href="https://wyam.io">Wyam</a>
            </footer>
        </div>
        <a href="javascript:" id="return-to-top"><i class="fa fa-chevron-up"></i></a>
        
        <script>           
            // Close the sidebar if we select an anchor link
            $(".main-sidebar a[href^='#']:not('.expand')").click(function(){
                $(document.body).removeClass('sidebar-open');
            });
            
            $(document).ready(function() {
                mermaid.initialize(
                {
                    flowchart:
                    {
                        useMaxWidth: false
                    },
					startOnLoad: false,
					cloneCssStyles: false
                });     
                mermaid.init(undefined, ".mermaid");

                // Remove the max-width setting that Mermaid sets
                var mermaidSvg = $('.mermaid svg');
                mermaidSvg.addClass('img-responsive');
                mermaidSvg.css('max-width', '');

                // Make it scrollable
				var target = document.querySelector(".mermaid svg");
				if(target !== null)
				{
					var panZoom = window.panZoom = svgPanZoom(target, {
						zoomEnabled: true,
						controlIconsEnabled: true,
						fit: true,
						center: true,
                        maxZoom: 20,
                        zoomScaleSensitivity: 0.6
					});			                          

                    // Do the reset once right away to fit the diagram
                    panZoom.resize();
                    panZoom.fit();
                    panZoom.center();
                    
                    $(window).resize(function(){
                        panZoom.resize();
                        panZoom.fit();
                        panZoom.center();
                    });
				}
                
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                });  
            });

            hljs.initHighlightingOnLoad();

            // Back to top
            $(window).scroll(function() {
                if ($(this).scrollTop() >= 200) {        // If page is scrolled more than 50px
                    $('#return-to-top').fadeIn(1000);    // Fade in the arrow
                } else {
                    $('#return-to-top').fadeOut(1000);   // Else fade out the arrow
                }
            });
            $('#return-to-top').click(function() {      // When arrow is clicked
                $('body,html').animate({
                    scrollTop : 0                       // Scroll to top of body
                }, 500);
            });
        </script>
    
</body></html>