<!DOCTYPE html><html><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="description">
        <meta name="keywords" content="static content generator,static site generator,static site,HTML,web development,.NET,C#,Razor,Markdown,YAML">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <title>Animancer - Airborne</title>
        <link href="/animancer/v4-0/assets/css/highlight.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/bootstrap/bootstrap.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/adminlte/AdminLTE.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/theme/theme.css" rel="stylesheet">
        <link href="//fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:400,400i,700,700i" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/animancer/v4-0/assets/css/override.css" rel="stylesheet">
        <script src="/animancer/v4-0/assets/js/jquery-2.2.3.min.js"></script>
        <script src="/animancer/v4-0/assets/js/bootstrap.min.js"></script>        
        <script src="/animancer/v4-0/assets/js/app.min.js"></script>         
        <script src="/animancer/v4-0/assets/js/highlight.pack.js"></script>   
        <script src="/animancer/v4-0/assets/js/jquery.slimscroll.min.js"></script>
        <script src="/animancer/v4-0/assets/js/jquery.sticky-kit.min.js"></script>
        <script src="/animancer/v4-0/assets/js/mermaid.min.js"></script>
        <script src="/animancer/v4-0/assets/js/svg-pan-zoom.min.js"></script>
        <!--[if lt IE 9]>
        <script src="/animancer/v4-0/assets/js/html5shiv.min.js"></script>
        <script src="/animancer/v4-0/assets/js/respond.min.js"></script>
        <![endif]-->  

        
    </head>
    <body class="hold-transition wyam layout-boxed  ">    
        <div class="top-banner"></div>
        <div class="wrapper with-container">
            <!-- Header -->
            <header class="main-header">   
                     
                <a href="/animancer/v4-0/" class="logo">
                            <span>Animancer</span>
                </a>   
                         
                <nav class="navbar navbar-static-top" role="navigation">
                    <!-- Sidebar toggle button-->
                        <a href="#" class="sidebar-toggle visible-xs-block" data-toggle="offcanvas" role="button">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-right"></i>
                        </a>
                                        
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-down"></i>
                        </button>
                    </div>
            
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                        <ul class="nav navbar-nav">                            
                                    <li class="active"><a href="/animancer/v4-0/docs"><img src="/animancer/v4-0/images/docs.png" height="20" style="position:relative; left:-5px; top:-1px;"> Docs</a></li>
        <li><a href="/animancer/v4-0/docs/help"><img src="/animancer/v4-0/images/help.png" height="20" style="position:relative; left:-4px; top:-1px;"> Help</a></li>
        <li><a href="/animancer/v4-0/api/Animancer/AnimancerComponent"><img src="/animancer/v4-0/images/api.png" height="20" style="position:relative; left:-3px; top:-1px;"> API v4.0</a></li>
        <li><a href="/animancer/lite"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Try</a></li>
        <li><a href="/animancer/pro"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Buy</a></li>
        <li><a href="https://kybernetik.com.au/kailas-dierk/unity-assets"><img src="/animancer/v4-0/images/kybernetik.png" height="20" style="position:relative; left:-2px; top:-1px;"> Other Assets</a></li>
 
                        </ul>       
                    </div>
                    <!-- /.navbar-collapse -->
                
                    <!-- Navbar Right Menu -->
                </nav>
<a href="/animancer" style="font-size:1.42em; color:white">This is the <strong>Animancer v4.0 Beta</strong> Documentation. Click Here to return to the v3.1 Documentation.</a>
            </header>
            
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="main-sidebar ">
                <section class="infobar" data-spy="affix" data-offset-top="60" data-offset-bottom="200"> 
                    	
    <div id="infobar-headings"><h6>On This Page</h6><p><a href="#original">Original</a></p>
<p><a href="#animancer">Animancer</a></p>
<p><a href="#controller-state">Controller State</a></p>
<p><a href="#updates">Updates</a></p>
<p><a href="#jumping">Jumping</a></p>
<hr class="infobar-hidden">
</div>

                </section>
                <section class="sidebar">    
                                     
                    

                    <ul class="sidebar-menu">
                        

                <li><a href="/animancer/v4-0/docs/help">Help and FAQ</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction">Introduction</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/features">Features</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer">Mecanim vs. Animancer</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/why-replace-mecanim">Why Replace Mecanim?</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/playing">Playing</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/waiting">Waiting</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/speed-and-time">Speed and Time</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/weapon-animations">Weapon Animations</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/performance">Performance</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/introduction/glossary">Glossary</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/cs">C# in Unity</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/cs/overview">Scripting Overview</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/organisation">Organisation</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/variables">Variables</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/methods">Methods</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/inheritance">Inheritance</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/vectors">Vectors</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/other">Other Topics</a></li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples">Examples</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/basics">01 Basics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/basics/scene-setup">Basic Scene Setup</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/quick-play">01 Quick Play</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/playing-and-fading">02 Playing and Fading</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/sequence-coroutine">03 Sequence Coroutine</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/named-animations">04 Named Animations</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/hybrid">05 Hybrid Basics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/fine-control">02 Fine Control</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/fine-control/spider-bot">01 Spider Bot</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/doors">02 Doors</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/solo-animation">03 Solo Animation</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/locomotion">03 Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/locomotion/walk-and-run">01 Walk and Run</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/root-motion">02 Root Motion</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/linear-blending">03 Linear Blending</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/directional-blending">04 Directional Blending</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/directional-sprites">04 Directional Sprites</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/basic-movement">01 Basic Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/character-controller">02 Character Controller</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/events">05 Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/events/footsteps">01 Footstep Events</a></li>
                <li><a href="/animancer/v4-0/docs/examples/events/golf">02 Golf Events</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/fsm">06 State Machines</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/fsm/creatures">01 Creatures</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/interrupt-management">02 Interrupt Management</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/brains">03 Brains</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/more-brains">04 More Brains</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fsm/platformer">05 Platformer</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/examples/layers">07 Layers</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/ik">08 Inverse Kinematics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/ik/puppet">01 Puppet</a></li>
                <li><a href="/animancer/v4-0/docs/examples/ik/uneven-ground">02 Uneven Ground</a></li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers">09 Animator Controllers</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/hybrid">01 Hybrid Mini Game</a></li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit">02 3D Game Kit</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/problems">Problems with the Original</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/respawn">Respawn</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/idle">Idle</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion">Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/movement">Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/turning">Turning</a></li>

                    </ul>
                </li>
                <li class="selected"><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/airborne">Airborne</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/landing">Landing</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/attack">Attack</a></li>

                    </ul>
                </li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual">User Manual</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/playing">Playing Animations</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/playing/states">States</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/inspector">Inspector</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/component-types">Component Types</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/directional-sets">Directional Animation Sets</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/transitions">Transitions</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/transitions/types">Transition Types</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/blending">Blending</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/blending/fading">Fading</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/layers">Layers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/mixers">Mixers</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/events">Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/events/animation">Animation Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/animancer">Animancer Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/end">End Events</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/manual/fsm">Finite State Machines</a></li>
                <li><a href="/animancer/v4-0/docs/manual/animator-controllers">Animator Controllers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/ik">Inverse Kinematics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/bugs">Unity Bugs</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/bugs/inconsistent-timing">Inconsistent Timing</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/paused-skinned-mesh-update">Paused Skinned Mesh Update</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/resetting-animated-values">Resetting Animated Values</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/unused-graph-destroy-warning">Unused Graph Destroy Warning</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/update-modes">Update Modes</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/source">Source Code</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/source/dlls">DLLs</a></li>
                <li><a href="/animancer/v4-0/docs/source/creating-custom-states">Creating Custom States</a></li>
                <li><a href="/animancer/v4-0/docs/source/graph-structure">Graph Structure</a></li>
                <li><a href="/animancer/v4-0/docs/source/asset-sources">Asset Sources</a></li>
                <li><a href="/animancer/v4-0/docs/source/coding-standard">Coding Standard</a></li>
                <li><a href="/animancer/v4-0/docs/source/default-script-template">Default Script Template</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/changes">Change Log</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0-beta">Beta Test v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0">Progress of v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-1">Animancer v3.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-0">Animancer v3.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v2-0">Animancer v2.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-3">Animancer v1.3</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-2">Animancer v1.2</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-1">Animancer v1.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-0">Animancer v1.0</a></li>

                    </ul>
                </li>

                    </ul>
                            
                </section>                
            </aside>
            
            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                



		<section class="content-header">
			<h1>Airborne</h1>
		</section>
	<section class="content">
		<blockquote class="blockquote">
<p>This page is part of the <a href="../">3D Game Kit</a> example.</p>
</blockquote>
<h1 id="original">Original</h1>
<p>Rather than having individual states for <em>Jump</em> and <em>Fall</em> animations, the character only has one <em>Airborne</em> Blend Tree which uses the character's <code>AirborneVerticalSpeed</code> to control its blending. This is a useful setup because it means that you can tweak the physics details like gravity and jump speed and the animation will still be correct for any given point in the jump arc.</p>
<p><img src="jump.gif" class="img-responsive"></p>
<p>Note that it actually has two vertical speed parameters: <code>VerticalSpeed</code> and <code>AirborneVerticalSpeed</code>. The latter is used in the <em>Airborne</em> Blend Tree and various other places while the former isn't set by any script and <em>seems</em> to be unused, however there is no way to actually make sure without manually going through every transition in the Animator Controller.</p>
<p></p><details><summary>Every <code>PlayerController.FixedUpdate</code> calls <code>CalculateVerticalMovement</code> which is responsible for enforcing a constant downward speed while grounded to stick to the ground, checking if the <code>PlayerInput</code> wants to jump, applying gravity while airborne, and applying additional downward acceleration if the player jumps and releases the button before they reach the peak of the jump:</summary><p>
</p><pre><code class="language-cs">void CalculateVerticalMovement()
{
    // If jump is not currently held and Ellen is on the ground then she is ready to jump.
    if (!m_Input.JumpInput &amp;&amp; m_IsGrounded)
        m_ReadyToJump = true;

    if (m_IsGrounded)
    {
        // When grounded we apply a slight negative vertical speed to make Ellen "stick" to the ground.
        m_VerticalSpeed = -gravity * k_StickingGravityProportion;

        // If jump is held, Ellen is ready to jump and not currently in the middle of a melee combo...
        if (m_Input.JumpInput &amp;&amp; m_ReadyToJump &amp;&amp; !m_InCombo)
        {
            // ... then override the previously set vertical speed and make sure she cannot jump again.
            m_VerticalSpeed = jumpSpeed;
            m_IsGrounded = false;
            m_ReadyToJump = false;
        }
    }
    else
    {
        // If Ellen is airborne, the jump button is not held and Ellen is currently moving upwards...
        if (!m_Input.JumpInput &amp;&amp; m_VerticalSpeed &gt; 0.0f)
        {
            // ... decrease Ellen's vertical speed.
            // This is what causes holding jump to jump higher that tapping jump.
            m_VerticalSpeed -= k_JumpAbortSpeed * Time.deltaTime;
        }

        // If a jump is approximately peaking, make it absolute.
        if (Mathf.Approximately(m_VerticalSpeed, 0f))
        {
            m_VerticalSpeed = 0f;
        }

        // If Ellen is airborne, apply gravity.
        m_VerticalSpeed -= gravity * Time.deltaTime;
    }
}
</code></pre>
<p>Checking when the vertical speed is approximately 0 to set it to exactly 0 seems totally pointless because the threshold is so small that it will rarely happen and even if it does it will only be for a single frame and will not look notably different anyway.</p>
<p></p></details><p></p>
<p>After that method, <code>OnAnimatorMove</code> adds the <code>m_VerticalSpeed</code> to the movement it executes that frame and also sets it as the <code>AirborneVerticalSpeed</code> parameter in the Animator Controller to control the Blend Tree.</p>
<h1 id="animancer">Animancer</h1>
<p></p><details><summary>Animancer manages the above logic using the <code><a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/AirborneState">AirborneState</a></code> script which uses a Blend Tree in the same way, except that the Animator Controller contains only that Blend Tree and nothing else:</summary><p>
</p><pre><code class="language-cs">using Animancer;
using UnityEngine;

public sealed class <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/AirborneState">AirborneState</a> : CreatureState
{
    [SerializeField] private RuntimeAnimatorController _AirborneBlendTree;

    private <a href="/animancer/v4-0/api/Animancer/ControllerState">ControllerState</a> _ControllerState;

    private static readonly int VerticalSpeedParameter = Animator.StringToHash("VerticalSpeed");

    private void Awake()
    {
        _ControllerState = new ControllerState(Animancer, _AirborneBlendTree);
    }

    private void ApplyVerticalSpeed()
    {
        _ControllerState.Playable.SetFloat(VerticalSpeedParameter, Creature.VerticalSpeed);
    }

    [SerializeField] private float _JumpSpeed = 10;
    [SerializeField] private float _JumpAbortSpeed = 10;
    [SerializeField] private float _TurnSpeedProportion = 5.4f;
    [SerializeField] private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/LandingState">LandingState</a> _LandingState;
    [SerializeField] private <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/RandomAudioPlayer">RandomAudioPlayer</a> _EmoteJumpAudio;

    private bool _IsJumping;

    private void OnEnable()
    {
        _IsJumping = false;
        Animancer.CrossFade(_ControllerState);
        ApplyVerticalSpeed();
    }

    public override bool StickToGround { get { return false; } }

    public override Vector3 <a href="/animancer/v4-0/api/Animancer.Examples.Locomotion/RootMotion">RootMotion</a>
    {
        get
        {
            return Creature.Brain.Movement * (Creature.ForwardSpeed * Time.deltaTime);
        }
    }

    private void FixedUpdate()
    {
        if (_IsJumping)
        {
            if (Creature.VerticalSpeed &lt;= 0)
                _IsJumping = false;
        }
        else
        {
            if (_LandingState != null)
            {
                if (Creature.StateMachine.TrySetState(_LandingState))
                    return;
            }

            if (Creature.CheckMotionState())
                return;

            if (Creature.VerticalSpeed &gt; 0)
                <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/991407AC">Creature.VerticalSpeed</a> -= _JumpAbortSpeed * Time.deltaTime;
        }

        ApplyVerticalSpeed();

        Creature.UpdateSpeedControl();

        var input = Creature.Brain.Movement;

        var turnSpeed = Vector3.Angle(Creature.transform.forward, input) * (1f / 180) *
            _TurnSpeedProportion *
            Creature.CurrentTurnSpeed;

        Creature.TurnTowards(input, turnSpeed);
    }

    public bool TryJump()
    {
        if (Creature.CharacterController.isGrounded &amp;&amp;
            Creature.StateMachine.TryResetState(this))
        {
            _IsJumping = true;
            <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/991407AC">Creature.VerticalSpeed</a> = _JumpSpeed;

            _EmoteJumpAudio.PlayRandomClip();

            return true;
        }

        return false;
    }

    public void CancelJump()
    {
        _IsJumping = false;
    }
}
</code></pre>
<p>Checking when the vertical speed is approximately 0 to set it to exactly 0 seems totally pointless because the threshold is so small that it will rarely happen and even if it does it will only be for a single frame and will not look notably different anyway.</p>
<p></p></details><p></p>
<h1 id="controller-state">Controller State</h1>
<p>Since plenty of other examples demonstrate how to use <a href="../../../../manual/transitions">Transitions</a>, this one instead shows how to create a <code><a href="/animancer/v4-0/api/Animancer/ControllerState">ControllerState</a></code> and access its parameters manually.</p>
<p>Firstly we need several fields:</p>
<table class="table">
<thead>
<tr>
<th>Field</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[SerializeField] private RuntimeAnimatorController _AirborneBlendTree;</code></td>
<td>A reference to the Animator Controller containing the same Blend Tree used by the original character, but nothing else.</td>
</tr>
<tr>
<td><code>private <a href="/animancer/v4-0/api/Animancer/ControllerState">ControllerState</a> _ControllerState;</code></td>
<td>The <code><a href="/animancer/v4-0/api/Animancer/AnimancerState">AnimancerState</a></code> that will play the Animator Controller and provide access to its parameters.</td>
</tr>
<tr>
<td><code>private static readonly int VerticalSpeedParameter = Animator.StringToHash("VerticalSpeed");</code></td>
<td>The hash code of the <code>VerticalSpeed</code> parameter to allow us to access it more efficiently than using the name every time.</td>
</tr>
</tbody>
</table>
<p>On startup we create the <code><a href="/animancer/v4-0/api/Animancer/ControllerState">ControllerState</a></code> using the creature's <code><a href="/animancer/v4-0/api/Animancer/AnimancerComponent">AnimancerComponent</a></code> which will implicitly attach the state to its default layer and also the <code>RuntimeAnimatorController</code> we want it to play:</p>
<pre><code class="language-cs">private void Awake()
{
    _ControllerState = new ControllerState(Animancer, _AirborneBlendTree);
}
</code></pre>
<p>Whenever this state is entered it passes the <code>_ControllerState</code> into the <code>AnimancerComponent.CrossFade</code> method to transition to it (over the default 0.25 second fade duration) just the same as we would if it were an <code>AnimationClip</code>:</p>
<pre><code class="language-cs">private void OnEnable()
{
    Animancer.CrossFade(_ControllerState);
}
</code></pre>
<p>Then every <code>FixedUpdate</code> we need to tell the Animator Controller what the vertical speed is:</p>
<pre><code class="language-cs">private void ApplyVerticalSpeed()
{
    _ControllerState.Playable.SetFloat(VerticalSpeedParameter, Creature.VerticalSpeed);
}
</code></pre>
<h2 id="float-controller-state">Float Controller State</h2>
<p>Since the main purpose of that <code><a href="/animancer/v4-0/api/Animancer/ControllerState">ControllerState</a></code> is to provide access to a single float parameter, it would be more convenient to use a <code><a href="/animancer/v4-0/api/Animancer/Float1ControllerState">Float1ControllerState</a></code> which would replace all of the above with this:</p>
<pre><code class="language-cs">[SerializeField] private RuntimeAnimatorController _AirborneBlendTree;

private <a href="/animancer/v4-0/api/Animancer/Float1ControllerState">Float1ControllerState</a> _ControllerState;

private void Awake()
{
    _ControllerState = new Float1ControllerState(Animancer, _AirborneBlendTree, "VerticalSpeed");
}

private void OnEnable()
{
    Animancer.CrossFade(_ControllerState);
}

private void ApplyVerticalSpeed()
{
    _ControllerState.Parameter = Creature.VerticalSpeed;
}
</code></pre>
<p>Note how we no longer need the static <code>VerticalSpeedParameter</code> to cache the hash code because we pass the parameter name into the <code><a href="/animancer/v4-0/api/Animancer/Float1ControllerState">Float1ControllerState</a></code> constructor and then we are able to get and set that parameter using <code>_ControllerState.Parameter = ...</code>.</p>
<h2 id="transition">Transition</h2>
<p><a href="../../../../manual/transitions">Transitions</a> (specifically, a <code><a href="/animancer/v4-0/api/Animancer/Transition">Float1ControllerState.Transition</a></code>) can simplify this setup even further:</p>
<pre><code class="language-cs">[SerializeField] private <a href="/animancer/v4-0/api/Animancer/Transition">Float1ControllerState.Transition</a> _AirborneBlendTree;

private void OnEnable()
{
    Animancer.Transition(_AirborneBlendTree);
}

private void ApplyVerticalSpeed()
{
    _AirborneBlendTree.State.Parameter = Creature.VerticalSpeed;
}
</code></pre>
<p>This gives us several advantages over the manual approaches above:</p>
<ul>
<li>We only need a single field.</li>
<li>We call <code>AnimancerComponent.Transition</code> instead of <code>CrossFade</code> which automatically creates the <code><a href="/animancer/v4-0/api/Animancer/ControllerState">ControllerState</a></code> so we do not need the <code>Awake</code> method either.</li>
<li><code>CrossFade</code> takes a <code>fadeDuration</code> parameter which is hard coded to 0.25 seconds by default, but the transition has an Inspector field to allow it to be tweaked by non-programmers.</li>
<li>The parameter name is handled by a dropdown menu in the Inspector so it's not hard coded and you get a clear list of all available parameters. This means the code isn't tied to a specific parameter name and you do not have the chance to misspell it.</li>
</ul>
<p><img src="airborne-transition.png" class="img-responsive"></p>
<h1 id="updates">Updates</h1>
<p>There are several aspects to this state every update.</p>
<p>Firstly, we override the <code>StickToGround</code> property to always be false and the <code><a href="/animancer/v4-0/api/Animancer.Examples.Locomotion/RootMotion">RootMotion</a></code> property to go whichever direction the <code>Creature.Brain</code> is trying to move as explained on the <a href="../locomotion/movement#on-animator-move-1">Movement</a> page.</p>
<p>Then the <code>FixedUpdate</code> method executes the main logic of this state.</p>
<p>It starts by making sure that when you jump, do not start checking if you have landed until you stop going up:</p>
<pre><code class="language-cs">private void FixedUpdate()
{
    if (_IsJumping)
    {
        if (Creature.VerticalSpeed &lt;= 0)
            _IsJumping = false;
    }
</code></pre>
<p>Otherwise, if there is a <a href="../landing">Landing</a> state we try to enter it, which that script won't allow until the <code>CharacterController</code> is grounded. Or if we do not have a specific state for landing, just check the default transitions to Idle or Locomotion.</p>
<pre><code class="language-cs">    else
    {
        if (_LandingState != null)
        {
            if (Creature.StateMachine.TrySetState(_LandingState))
                return;
        }
        else
        {
            if (Creature.CheckMotionState())
                return;
        }
</code></pre>
<p>Note that the <code><a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/LandingState">LandingState</a></code> isn't referenced by any other scripts. It isn't a standard state that every <code>Creature</code> needs and nothing else needs to directly know about it.</p>
<p>Here we also apply some additional downward acceleration (on top of the regular graivty applied in <code>Creature.OnAnimatorMove</code>) if the player releases the jump button early (this is still inside the block where <code>_IsJumping</code> is false, meaning the jump was cancelled):</p>
<pre><code class="language-cs">        if (Creature.VerticalSpeed &gt; 0)
            <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/991407AC">Creature.VerticalSpeed</a> -= _JumpAbortSpeed * Time.deltaTime;
    }
</code></pre>
<p>Lastly, we send the vertical speed to the Animator Controller for the Blend Tree to use and update the <code>Creature</code>'s speed and turning. Since we do not have quick turn animations like the LocomotionState, we just increase the turn speed when the direction we want to go is further away from the direction we are currently facing.</p>
<pre><code class="language-cs">    ApplyVerticalSpeed();

    Creature.UpdateSpeedControl();

    var input = Creature.Brain.Movement;

    var turnSpeed = Vector3.Angle(Creature.transform.forward, input) * (1f / 180) *
        _TurnSpeedProportion *
        Creature.CurrentTurnSpeed;

    Creature.TurnTowards(input, turnSpeed);
}
</code></pre>
<h1 id="jumping">Jumping</h1>
<p>The original character's implementation of jumping was extremely disorganised and hard to follow:</p>
<ol>
<li><code>PlayerInput.Update</code> checks for a button press to set a <code>bool</code> field with a public wrapper property.</li>
<li>Searching for references to that property finds one in <code>PlayerController.CalculateVerticalMovement</code> which makes sure the button had been released at some point since the last jump (<code>PlayerInput</code> should have handled that).</li>
<li>It also checks to make sure the character isn't attacking.</li>
<li>Then it sets the <code>m_VerticalSpeed = jumpSpeed;</code> and <code>m_IsGrounded = false;</code>.</li>
<li>If you search for the actual call to <code>CalculateVerticalMovement</code> you'll find it in the middle of <code>FixedUpdate</code>. Note that this means it can miss fast keypresses if they happen during one <code>Update</code> and another one occurs before the next <code>FixedUpdate</code>.</li>
<li>That method doesn't actually tell the Animator Controller anything, but if you search for references to <code>m_IsGrounded</code> you can find that <code>OnAnimatorMove</code> (which is called separately after <code>FixedUpdate</code> is done) passes it on to the Animator Controller.</li>
<li>If you look at the Animator Controller you can find that once the <code>IsGrounded</code> parameter is set, the Animator Controller will transition to the <em>Airborne</em> state ... <a href="../problems#locomotion">except that sometimes it doesn't</a>.</li>
<li>At the end of the <code>FixedUpdate</code> it calls <code>PlayAudio</code> which checks <code>if (!m_IsGrounded &amp;&amp; m_PreviouslyGrounded &amp;&amp; m_VerticalSpeed &gt; 0f)</code> in order to play the jump sound.</li>
</ol>
<p>The Animancer implementation is much easier to follow:</p>
<ol>
<li><code><a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/KeyboardAndMouseBrain">KeyboardAndMouseBrain</a></code> checks for a button press to call <code>Creature.Airborne.TryJump();</code>.</li>
<li>That method clearly defines everything involved in jumping:</li>
</ol>
<p>You can only jump while grounded:</p>
<pre><code class="language-cs">public bool TryJump()
{
    if (Creature.CharacterController.isGrounded &amp;&amp;
</code></pre>
<p>Then we try to enter this state. We didn't override <code>CanEnterState</code> to check if the <code>Creature</code> is grounded because this state is also used if you walk off a ledge, so instead we check that condition here when specifically attempting to jump. That means this state will always allow itself to be entered, so we are only depending on the previous state's <code>CanExitState</code> to return true. Unlike the original character, this method doesn't specifically care if the character is attacking, it simply lets the state machine ask if the previous state will allow the change. If you add some other ability or action that doesn't want to be interrupted, this method will continue working properly without needing to be modified.</p>
<pre><code class="language-cs">        Creature.StateMachine.TryResetState(this))
</code></pre>
<p>If the state is changed, it will enable this script (because it inherits from <code>StateBehaviour</code>) which will call its <code>OnEnable</code> method.</p>
<p>Now that we are in this state, flag it as a jump (so it can be cancelled to apply additional downward acceleration), apply the jump speed, and play a jump sound:</p>
<pre><code class="language-cs">    {
        _IsJumping = true;
        <a href="/animancer/v4-0/api/Animancer.Examples.AnimatorControllers.GameKit/Creature/991407AC">Creature.VerticalSpeed</a> = _JumpSpeed;

        _EmoteJumpAudio.PlayRandomClip();
</code></pre>
<p>And finally, use the return value to indicate whether the jump was successful:</p>
<pre><code class="language-cs">        return true;
    }

    return false;
}
</code></pre>
<p>Then if you want to know what happens over time during the jump, you can simply examine the rest of this class, particularly the <code>FixedUpdate</code> method.</p>

	</section>
                
            </div>           
            
            <!-- Footer -->
            <footer class="main-footer">
            </footer>
            
        </div>
        <div class="wrapper bottom-wrapper">
            <footer class="bottom-footer">
                Generated by <a href="https://wyam.io">Wyam</a>
            </footer>
        </div>
        <a href="javascript:" id="return-to-top"><i class="fa fa-chevron-up"></i></a>
        
        <script>           
            // Close the sidebar if we select an anchor link
            $(".main-sidebar a[href^='#']:not('.expand')").click(function(){
                $(document.body).removeClass('sidebar-open');
            });
            
            $(document).ready(function() {
                mermaid.initialize(
                {
                    flowchart:
                    {
                        useMaxWidth: false
                    },
					startOnLoad: false,
					cloneCssStyles: false
                });     
                mermaid.init(undefined, ".mermaid");

                // Remove the max-width setting that Mermaid sets
                var mermaidSvg = $('.mermaid svg');
                mermaidSvg.addClass('img-responsive');
                mermaidSvg.css('max-width', '');

                // Make it scrollable
				var target = document.querySelector(".mermaid svg");
				if(target !== null)
				{
					var panZoom = window.panZoom = svgPanZoom(target, {
						zoomEnabled: true,
						controlIconsEnabled: true,
						fit: true,
						center: true,
                        maxZoom: 20,
                        zoomScaleSensitivity: 0.6
					});			                          

                    // Do the reset once right away to fit the diagram
                    panZoom.resize();
                    panZoom.fit();
                    panZoom.center();
                    
                    $(window).resize(function(){
                        panZoom.resize();
                        panZoom.fit();
                        panZoom.center();
                    });
				}
                
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                });  
            });

            hljs.initHighlightingOnLoad();

            // Back to top
            $(window).scroll(function() {
                if ($(this).scrollTop() >= 200) {        // If page is scrolled more than 50px
                    $('#return-to-top').fadeIn(1000);    // Fade in the arrow
                } else {
                    $('#return-to-top').fadeOut(1000);   // Else fade out the arrow
                }
            });
            $('#return-to-top').click(function() {      // When arrow is clicked
                $('body,html').animate({
                    scrollTop : 0                       // Scroll to top of body
                }, 500);
            });
        </script>
    
</body></html>