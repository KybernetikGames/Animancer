<!DOCTYPE html><html><head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="description">
        <meta name="keywords" content="static content generator,static site generator,static site,HTML,web development,.NET,C#,Razor,Markdown,YAML">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/animancer/v4-0/assets/img/favicon.ico" type="image/x-icon">
        <title>Animancer - 04 More Brains</title>
        <link href="/animancer/v4-0/assets/css/highlight.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/bootstrap/bootstrap.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/adminlte/AdminLTE.css" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/theme/theme.css" rel="stylesheet">
        <link href="//fonts.googleapis.com/css?family=Roboto+Mono:400,700|Roboto:400,400i,700,700i" rel="stylesheet">
        <link href="/animancer/v4-0/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/animancer/v4-0/assets/css/override.css" rel="stylesheet">
        <script src="/animancer/v4-0/assets/js/jquery-2.2.3.min.js"></script>
        <script src="/animancer/v4-0/assets/js/bootstrap.min.js"></script>        
        <script src="/animancer/v4-0/assets/js/app.min.js"></script>         
        <script src="/animancer/v4-0/assets/js/highlight.pack.js"></script>   
        <script src="/animancer/v4-0/assets/js/jquery.slimscroll.min.js"></script>
        <script src="/animancer/v4-0/assets/js/jquery.sticky-kit.min.js"></script>
        <script src="/animancer/v4-0/assets/js/mermaid.min.js"></script>
        <script src="/animancer/v4-0/assets/js/svg-pan-zoom.min.js"></script>
        <!--[if lt IE 9]>
        <script src="/animancer/v4-0/assets/js/html5shiv.min.js"></script>
        <script src="/animancer/v4-0/assets/js/respond.min.js"></script>
        <![endif]-->  

        
    </head>
    <body class="hold-transition wyam layout-boxed  ">    
        <div class="top-banner"></div>
        <div class="wrapper with-container">
            <!-- Header -->
            <header class="main-header">   
                     
                <a href="/animancer/v4-0/" class="logo">
                            <span>Animancer</span>
                </a>   
                         
                <nav class="navbar navbar-static-top" role="navigation">
                    <!-- Sidebar toggle button-->
                        <a href="#" class="sidebar-toggle visible-xs-block" data-toggle="offcanvas" role="button">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-right"></i>
                        </a>
                                        
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                            <span class="sr-only">Toggle side menu</span>
                            <i class="fa fa-chevron-circle-down"></i>
                        </button>
                    </div>
            
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-left" id="navbar-collapse">
                        <ul class="nav navbar-nav">                            
                                    <li class="active"><a href="/animancer/v4-0/docs"><img src="/animancer/v4-0/images/docs.png" height="20" style="position:relative; left:-5px; top:-1px;"> Docs</a></li>
        <li><a href="/animancer/v4-0/docs/help"><img src="/animancer/v4-0/images/help.png" height="20" style="position:relative; left:-4px; top:-1px;"> Help</a></li>
        <li><a href="/animancer/v4-0/api/Animancer/AnimancerComponent"><img src="/animancer/v4-0/images/api.png" height="20" style="position:relative; left:-3px; top:-1px;"> API v4.0</a></li>
        <li><a href="/animancer/lite"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Try</a></li>
        <li><a href="/animancer/pro"><img src="/animancer/v4-0/images/unity-logo.png" height="20" style="position:relative; left:-4px; top:-1px;"> Buy</a></li>
        <li><a href="https://kybernetikgames.github.io/kailas-dierk/unity-assets"><img src="/animancer/v4-0/images/kybernetik.png" height="20" style="position:relative; left:-2px; top:-1px;"> Other Assets</a></li>
 
                        </ul>       
                    </div>
                    <!-- /.navbar-collapse -->
                
                    <!-- Navbar Right Menu -->
                </nav>
<a href="/animancer" style="font-size:1.42em; color:white">This is the <strong>Animancer v4.0 Beta</strong> Documentation. Click Here to return to the v3.1 Documentation.</a>
            </header>
            
            <!-- Left side column. contains the logo and sidebar -->
            <aside class="main-sidebar ">
                <section class="infobar" data-spy="affix" data-offset-top="60" data-offset-bottom="200"> 
                    	
    <div id="infobar-headings"><h6>On This Page</h6><p><a href="#mouse-brain">Mouse Brain</a></p>
<p><a href="#picking-a-target">Picking a Target</a></p>
<p><a href="#moving-towards-the-target">Moving Towards the Target</a></p>
<p><a href="#cancelling-the-target">Cancelling the Target</a></p>
<p><a href="#running">Running</a></p>
<p><a href="#live-brain-transplants">Live Brain Transplants</a></p>
<hr class="infobar-hidden">
</div>

                </section>
                <section class="sidebar">    
                                     
                    

                    <ul class="sidebar-menu">
                        

                <li><a href="/animancer/v4-0/docs/help">Help and FAQ</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction">Introduction</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer">Mecanim vs. Animancer</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/why-replace-mecanim">Why Replace Mecanim?</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/playing">Playing</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/waiting">Waiting</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/speed-and-time">Speed and Time</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/weapon-animations">Weapon Animations</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/mecanim-vs-animancer/performance">Performance</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/introduction/features">Features</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/glossary">Glossary</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/introduction/cs">C# in Unity</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/introduction/cs/overview">Scripting Overview</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/organisation">Organisation</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/variables">Variables</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/methods">Methods</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/inheritance">Inheritance</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/vectors">Vectors</a></li>
                <li><a href="/animancer/v4-0/docs/introduction/cs/other">Other Topics</a></li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples">Examples</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/basics">01 Basics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/basics/scene-setup">Basic Scene Setup</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/quick-play">01 Quick Play</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/playing-and-fading">02 Playing and Fading</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/sequence-coroutine">03 Sequence Coroutine</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/named-animations">04 Named Animations</a></li>
                <li><a href="/animancer/v4-0/docs/examples/basics/hybrid">05 Hybrid Basics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/fine-control">02 Fine Control</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/fine-control/spider-bot">01 Spider Bot</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/doors">02 Doors</a></li>
                <li><a href="/animancer/v4-0/docs/examples/fine-control/solo-animation">03 Solo Animation</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/locomotion">03 Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/locomotion/walk-and-run">01 Walk and Run</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/root-motion">02 Root Motion</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/linear-blending">03 Linear Blending</a></li>
                <li><a href="/animancer/v4-0/docs/examples/locomotion/directional-blending">04 Directional Blending</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/directional-sprites">04 Directional Sprites</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/basic-movement">01 Basic Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/directional-sprites/character-controller">02 Character Controller</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animation-events">05 Animation Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animation-events/simple-and-end-events">01 Simple and End Events</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animation-events/other-events">02 Other Events</a></li>

                    </ul>
                </li>
                <li class="treeview active">
                    <a href="/animancer/v4-0/docs/examples/state-machines">06 State Machines</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/state-machines/creatures">01 Creatures</a></li>
                <li><a href="/animancer/v4-0/docs/examples/state-machines/interrupt-management">02 Interrupt Management</a></li>
                <li><a href="/animancer/v4-0/docs/examples/state-machines/brains">03 Brains</a></li>
                <li class="selected"><a href="/animancer/v4-0/docs/examples/state-machines/more-brains">04 More Brains</a></li>
                <li><a href="/animancer/v4-0/docs/examples/state-machines/platformer">05 Platformer</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/examples/layers">07 Layers</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/inverse-kinematics">08 Inverse Kinematics</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/inverse-kinematics/puppet">01 Puppet</a></li>
                <li><a href="/animancer/v4-0/docs/examples/inverse-kinematics/uneven-ground">02 Uneven Ground</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers">09 Animator Controllers</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/hybrid">01 Hybrid</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit">02 3D Game Kit</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/problems">Problems with the Original</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/respawn">Respawn</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/idle">Idle</a></li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion">Locomotion</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/movement">Movement</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/locomotion/turning">Turning</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/airborne">Airborne</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/landing">Landing</a></li>
                <li><a href="/animancer/v4-0/docs/examples/animator-controllers/3d-game-kit/attack">Attack</a></li>

                    </ul>
                </li>

                    </ul>
                </li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual">User Manual</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/playing">Playing Animations</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/playing/states">States</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/inspector">Inspector</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/component-types">Component Types</a></li>
                <li><a href="/animancer/v4-0/docs/manual/playing/directional-sets">Directional Animation Sets</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/transitions">Transitions</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/transitions/types">Transition Types</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/blending">Blending</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/blending/fading">Fading</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/layers">Layers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/blending/mixers">Mixers</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/manual/events">Events</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/manual/events/animation">Animation Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/animancer">Animancer Events</a></li>
                <li><a href="/animancer/v4-0/docs/manual/events/end">End Events</a></li>

                    </ul>
                </li>
                <li><a href="/animancer/v4-0/docs/manual/finite-state-machines">Finite State Machines</a></li>
                <li><a href="/animancer/v4-0/docs/manual/animator-controllers">Animator Controllers</a></li>
                <li><a href="/animancer/v4-0/docs/manual/inverse-kinematics">Inverse Kinematics</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/bugs">Unity Bugs</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/bugs/inconsistent-timing">Inconsistent Timing</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/paused-skinned-mesh-update">Paused Skinned Mesh Update</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/resetting-animated-values">Resetting Animated Values</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/unused-graph-destroy-warning">Unused Graph Destroy Warning</a></li>
                <li><a href="/animancer/v4-0/docs/bugs/update-modes">Update Modes</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/source">Source Code</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/source/dlls">DLLs</a></li>
                <li><a href="/animancer/v4-0/docs/source/creating-custom-states">Creating Custom States</a></li>
                <li><a href="/animancer/v4-0/docs/source/graph-structure">Graph Structure</a></li>
                <li><a href="/animancer/v4-0/docs/source/asset-sources">Asset Sources</a></li>
                <li><a href="/animancer/v4-0/docs/source/coding-standard">Coding Standard</a></li>
                <li><a href="/animancer/v4-0/docs/source/default-script-template">Default Script Template</a></li>

                    </ul>
                </li>
                <li class="treeview">
                    <a href="/animancer/v4-0/docs/changes">Change Log</a> <a href="#" class="expand"></a>
                    <ul class="treeview-menu">
                        
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0-beta">Beta Test v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v4-0">Progress of v4.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-1">Animancer v3.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v3-0">Animancer v3.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v2-0">Animancer v2.0</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-3">Animancer v1.3</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-2">Animancer v1.2</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-1">Animancer v1.1</a></li>
                <li><a href="/animancer/v4-0/docs/changes/animancer-v1-0">Animancer v1.0</a></li>

                    </ul>
                </li>

                    </ul>
                            
                </section>                
            </aside>
            
            <!-- Content Wrapper. Contains page content -->
            <div class="content-wrapper">
                



		<section class="content-header">
			<h1>04 More Brains</h1>
		</section>
	<section class="content">
		<blockquote class="blockquote">
<p><strong>Difficulty</strong>: <a href="../../../introduction/glossary#example-difficulty">Intermediate</a></p>
<p><strong>Location</strong>: <em>Assets/Plugins/Animancer/Examples/06 State Machines/04 More Brains</em></p>
<p><strong>Namespace</strong>: <a href="../../../../api/Animancer.Examples.StateMachines.Brains"><code>Animancer.Examples.StateMachines.Brains</code></a></p>
</blockquote>
<p>This example expands upon the <a href="../brains">Brains</a> example to demonstrate how you can control each creature differently by using different brains even though they share the same scripts for actually performing actions. Specifically, it adds a new brain class that uses mouse input instead of keyboard input.</p>
<p>This concept extends to anything that might need to control a creature such as artificial intelligence for non-player characters, network messages in a multiplayer game, or pre-set events in a cutscene system.</p>
<p><img src="brain-transplant.gif" class="img-responsive"></p>
<h1 id="mouse-brain">Mouse Brain</h1>
<p>We are going to create a single new script to control the character with the mouse like you might in a top down game. Instead of moving in response to constant input like the <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/KeyboardBrain">KeyboardBrain</a></code>, this time we are going to implement a system where you click somewhere to have your character walk there on their own. In a real game you might use a pathfinding algorithm to have the character avoid obstacles in their way, but for this example we will just walk straight towards the target.</p>
<p>This script starts off the same as the <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/KeyboardBrain">KeyboardBrain</a></code> with a reference to the locomotion state:</p>
<pre><code class="language-cs">public sealed class <a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a> : CreatureBrain
{
    [SerializeField] private CreatureState _Locomotion;
}
</code></pre>
<h1 id="picking-a-target">Picking a Target</h1>
<p>The first thing we need is a field to store the target point:</p>
<pre><code class="language-cs">private Vector3 _Destination;
</code></pre>
<p>Then in <code>Update</code> we can check for mouse clicks:</p>
<pre><code class="language-cs">private void Update()
{
    if (Input.GetMouseButton(0))
    {
        _Destination = ???
    }
}
</code></pre>
<p>Note that we used <code>GetMouseButton</code> rather than <code>GetMouseButtonDown</code> so that it will continue recalculating the target point every frame while the button is held.</p>
<p>In order to find the world position the mouse cursor is actually pointing at we need to use a <a href="https://docs.unity3d.com/ScriptReference/Physics.Raycast.html">Raycast</a>:</p>
<pre><code class="language-cs">var ray = Camera.main.ScreenPointToRay(Input.mousePosition);

RaycastHit raycastHit;
if (Physics.Raycast(ray, out raycastHit))
{
    _Destination = raycastHit.point;
}
</code></pre>
<p>We want that ray to hit terrain but not the player (or any other creatures). Normally you might have creatures on their own layer and make a serialized <code>LayerMask</code> field to pass into the <code>Raycast</code> so you can use the Inspector to choose which layers it can hit. But since we don't want to mess with any layer settings just for this example, we can just go to the scene and set the <em>Creature</em> to the <code>Ignore Raycast</code> layer using the dropdown menu in the top right of the Inspector.</p>
<p>That raycast will tell us where the mouse cursor is pointing on the terrain (specifically, on any objects with colliders on layers that are included in whatever <code>LayerMask</code> we use) but it can't help us if the mouse is pointing out the edge of the scene so the ray doesn't hit any collider. To fix that, we can use a bit of simple maths to just find out where the ray intersects the horizontal <code>XZ</code> plane at a specific <code>Y</code> height:</p>
<pre><code class="language-cs">public static Vector3 CalculateRayTargetXZ(Ray ray, float y = 0)
{
    return ray.origin - ray.direction * ((ray.origin.y - y) / ray.direction.y);
}
</code></pre>
<p>Then we can use that method for when the raycast misses, using the creature's current height as the intersect height:</p>
<pre><code class="language-cs">_Destination = CalculateRayTargetXZ(ray, Creature.Rigidbody.position.y);
</code></pre>
<p></p><details><summary>The full <code>Update</code> method now looks like this:</summary><p>
</p><pre><code class="language-cs">private void Update()
{
    if (Input.GetMouseButton(0))
    {
        var ray = Camera.main.ScreenPointToRay(Input.mousePosition);

        RaycastHit raycastHit;
        if (Physics.Raycast(ray, out raycastHit))
        {
            _Destination = raycastHit.point;
        }
        else
        {
            _Destination = CalculateRayTargetXZ(ray, Creature.Rigidbody.position.y);
        }
    }
}
</code></pre>
<p></p></details><p></p>
<h1 id="moving-towards-the-target">Moving Towards the Target</h1>
<p>Now that we know where the player wants to go, we just need to tell the creature which way that is. We also want to do this in <code>Update</code>, so first we should split the method we just wrote out to keep the script organised:</p>
<pre><code class="language-cs">private void Update()
{
    UpdateInput();
    UpdateMovement();
}

private void UpdateInput()
{
    // The method we just wrote above.
}

private void UpdateMovement()
{
    // TODO.
}
</code></pre>
<p>So far we have a destination point, but the <code>MovementDirection</code> needs to actually be the direction from the creature to the destination. At a basic level, that only requires a simple subtraction:</p>
<pre><code class="language-cs">MovementDirection = _Destination - Creature.Rigidbody.position;
</code></pre>
<p>The last thing we need to do is tell the creature to enter the locomotion state:</p>
<pre><code class="language-cs">_Locomotion.TryEnterState();
</code></pre>
<p>This would give us a functional script that we could test in the scene, but it has an obvious problem: we're always telling it to move so it will immediately move towards the default <code>(0, 0, 0)</code> on startup and even after we pick a destination it will constantly try to move towards that point rather than returning to <em>Idle</em> once it arrives.</p>
<h1 id="cancelling-the-target">Cancelling the Target</h1>
<p>We could use a <code>bool _HasDestination</code> field, but this is a good use case for a C# feature called <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/nullable-types/">Nullable Types</a>.</p>
<p>By putting a <code>?</code> after the field type, we can change it from <em>"always a Vector3"</em> to <em>"either a Vector3 or null"</em> (which will default to null):</p>
<pre><code class="language-cs">private Vector3? _Destination;
</code></pre>
<p>The <code>UpdateInput</code> method can stay exactly the same, we still always want a destination when we click but when we implement <code>UpdateMovement</code> we will be able to clear it by setting <code>_Destination = null;</code> once the creature arrives at that point.</p>
<p>First we need a field to specify how close we want to try to get to the target because the character will practically never end up at exactly that point. We could try to adjust the movement speed to be more precise, but that's beyond the scope of this example so all we are going to do is stop when we get pretty close.</p>
<pre><code class="language-cs">[SerializeField] private float _StopDistance = 0.2f;
</code></pre>
<p>Start the method by making sure we actually have a destination and calculating the vector from the current position to the destination just like before (except that now we need to use <code>_Destination.Value</code> to access the actual <code>Vector3</code> value of the nullable):</p>
<pre><code class="language-cs">private void UpdateMovement()
{
    if (_Destination != null)
    {
        var fromCurrentToDestination = _Destination.Value - Creature.Rigidbody.position;
</code></pre>
<p>Then we compare the magnitude of that vector (its length) to the <code>_StopDistance</code>.</p>
<p>We can make a small optimization here. Vector magnitudes are calculated using Pythagoras' Theorem which involves a square root. Square roots are a much slower operation than simple arithmetic operations. Since we only need to see which is greater, we can compare the squared magnitude and stop distance without ever needing the actual magnitude.</p>
<pre><code class="language-cs">        if (fromCurrentToDestination.sqrMagnitude &gt; _StopDistance * _StopDistance)
</code></pre>
<p>If the remaining distance is greater than the stop distance, we set the <code>MovementDirection</code> and try to enter the <em>Locomotion</em> state.</p>
<pre><code class="language-cs">            MovementDirection = fromCurrentToDestination;
            _Locomotion.TryEnterState();
</code></pre>
<p>It doesn't do much in this example, but we can also use <code>Debug.DrawLine</code> to draw a line in the Scene window for debugging in case we ever need to see where a creature is going. The line will not show up in the Game window or in a runtime build, only in the Scene window in the Unity Editor.</p>
<pre><code class="language-cs">            Debug.DrawLine(Creature.Rigidbody.position, _Destination.Value, Color.cyan);
</code></pre>
<p>Lastly we just need to <code>return</code> early if the destination is far enough away that we still want to be in the <em>Locomotion</em> state, but otherwise we want to make sure everything is cleared and try to return to <em>Idle</em>.</p>
<pre><code class="language-cs">            return;
        }
    }

    _Destination = null;
    MovementDirection = Vector3.zero;
    Creature.Idle.TryEnterState();
</code></pre>
<h2 id="better-ray-targeting">Better Ray Targeting</h2>
<p>This is also a good time to fix a potential issue with the <code>CalculateRayTargetXZ</code> method. If the camera is above the target plane and the ray is pointing further up then it will obviously not intersect that plane by going forward, however the current implementation will calculate the intersection back in the other direction and return a point behind the camera which is very unlikely to be what the player actually intended to happen. The same thing happens if the camera is below the target plane and the ray is pointing downward. Fortunately, now that we have made the <code>_Destination</code> nullable, we can simply make the <code>CalculateRayTargetXZ</code> method return a nullable value as well and make it return null if the ray will not intersect the target plane by going forward:</p>
<pre><code class="language-cs">public static Vector3? CalculateRayTargetXZ(Ray ray, float y = 0)
{
    y = ray.origin.y - y;

    if (ray.direction.y == 0 || SameSign(y, ray.direction.y))
        return null;

    return ray.origin - ray.direction * (y / ray.direction.y);
}

public static bool SameSign(float x, float y)
{
    return
        (x &gt; 0 &amp;&amp; y &gt; 0) ||
        (x &lt; 0 &amp;&amp; y &lt; 0) ||
        (x == 0 &amp;&amp; y == 0);
}
</code></pre>
<p></p><details><summary>The full <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a></code> script looks like this so far:</summary><p>
</p><pre><code class="language-cs">using Animancer;
using Animancer.FSM;
using UnityEngine;

public sealed class <a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a> : CreatureBrain
{
    [SerializeField] private CreatureState _Locomotion;
    [SerializeField] private float _StopDistance = 0.2f;

    private Vector3? _Destination;

    private void Update()
    {
        UpdateInput();
        UpdateMovement();
    }

    private void UpdateInput()
    {
        if (Input.GetMouseButton(0))
        {
            var creaturePosition = Creature.Rigidbody.position;

            var ray = Camera.main.ScreenPointToRay(Input.mousePosition);

            RaycastHit raycastHit;
            if (Physics.Raycast(ray, out raycastHit))
            {
                _Destination = raycastHit.point;
            }
            else
            {
                _Destination = CalculateRayTargetXZ(ray, creaturePosition.y);
            }
        }
    }

    public static Vector3? CalculateRayTargetXZ(Ray ray, float y = 0)
    {
        y = ray.origin.y - y;

        if (ray.direction.y == 0 || SameSign(y, ray.direction.y))
            return null;

        return ray.origin - ray.direction * (y / ray.direction.y);
    }

    public static bool SameSign(float x, float y)
    {
        return
            (x &gt; 0 &amp;&amp; y &gt; 0) ||
            (x &lt; 0 &amp;&amp; y &lt; 0) ||
            (x == 0 &amp;&amp; y == 0);
    }

    private void UpdateMovement()
    {
        if (_Destination != null)
        {
            var fromCurrentToDestination = _Destination.Value - Creature.Rigidbody.position;

            if (fromCurrentToDestination.sqrMagnitude &gt; _StopDistance * _StopDistance)
            {
                MovementDirection = fromCurrentToDestination;
                _Locomotion.TryEnterState();
                Debug.DrawLine(Creature.Rigidbody.position, _Destination.Value, Color.cyan);
                return;
            }
        }

        _Destination = null;
        MovementDirection = Vector3.zero;
        Creature.Idle.TryEnterState();
    }
}
</code></pre>
<p></p></details><p></p>
<h2 id="seeing-it-in-action">Seeing it in Action</h2>
<p>We can now go back to the scene if we want to see it in action:</p>
<ol>
<li>Select the <em>Brain</em> object and remove the old <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/KeyboardBrain">KeyboardBrain</a></code>.</li>
<li>Add the new <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a></code> and assign its <code>Locomotion</code> reference.</li>
<li>Select the root <em>Creature</em> object and drag the <em>Brain</em> object into its <code>Brain</code> field to assign the new brain we just added.</li>
</ol>
<p>This gives us a character that we can steer around as long as we hold the mouse button and after we release they will continue moving to the past spot we were aiming. And we can still rotate the camera with Right Click thanks to the <code><a href="/animancer/v4-0/api/Animancer.Examples/OrbitControls">OrbitControls</a></code> script.</p>
<p><img src="mouse-walk.gif" class="img-responsive"></p>
<h1 id="running">Running</h1>
<p>We could bind running to a key like the <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/KeyboardBrain">KeyboardBrain</a></code>, but instead let's keep everything on the mouse by making the character run while we hold the button then walk once they get close to the destination or once the player releases the button.</p>
<p>First we need a field to determine how close they should get before walking:</p>
<pre><code class="language-cs">[SerializeField] private float _MinRunDistance = 1;
</code></pre>
<p>Then we just need to make some simple changes at the end of <code>UpdateInput</code>:</p>
<pre><code class="language-cs">private void UpdateInput()
{
    if (Input.GetMouseButton(0))
    {
        ...

        IsRunning = 
            _Destination != null &amp;&amp;
            Vector3.Distance(creaturePosition, _Destination.Value) &gt;= _MinRunDistance;
    }
    else
    {
        IsRunning = false;
    }
}
</code></pre>
<p>Now the character runs while we hold the button:</p>
<p><img src="mouse-run.gif" class="img-responsive"></p>
<h1 id="live-brain-transplants">Live Brain Transplants</h1>
<p>Usually each creature will have a single brain for their entire lifetime, however the fact that we have designed them as modular components means that you can easily swap between them if needed. This can be useful in a veriety of circumstances such as:</p>
<ul>
<li>When a player joins a multiplayer game, a <code>ControllerInputBrain</code> could take over control of a character from an <code>AIBrain</code>.</li>
<li>When a cutscene starts, it might want to take control of certain enemies and/or the player.</li>
<li>When a creature is hit by a <em>Fear</em> spell, it could swap their brain for a <code>FearBrain</code> which makes them run away for the duration of the spell before returning control to their regular brain.</li>
</ul>
<p>In this example we are going to swap between the two brain types we have made so far using simple UI buttons. One button disables the <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/KeyboardBrain">KeyboardBrain</a></code>, assigns the <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a></code> to the <code>Creature.Brain</code> field, and enables it, while the other button does the opposite.</p>
<h2 id="mouse-brain-1">Mouse Brain</h2>
<p>To get the <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a></code> ready for the swap, we need to do one last thing: make sure the destination is cleared when it gets re-enabled (you may or may not want to do this in a real game):</p>
<pre><code class="language-cs">private void OnEnable()
{
    _Destination = null;
}
</code></pre>
<p></p><details><summary>So the final <code><a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a></code> script looks like this:</summary><p>
</p><pre><code class="language-cs">using Animancer;
using Animancer.FSM;
using UnityEngine;

public sealed class <a href="/animancer/v4-0/api/Animancer.Examples.StateMachines.Brains/MouseBrain">MouseBrain</a> : CreatureBrain
{
    [SerializeField] private CreatureState _Locomotion;
    [SerializeField] private float _StopDistance = 0.2f;
    [SerializeField] private float _MinRunDistance = 1;

    private Vector3? _Destination;

    private void OnEnable()
    {
        _Destination = null;
    }

    private void Update()
    {
        UpdateInput();
        UpdateMovement();
    }

    private void UpdateInput()
    {
        if (Input.GetMouseButton(0))
        {
            var creaturePosition = Creature.Rigidbody.position;

            var ray = Camera.main.ScreenPointToRay(Input.mousePosition);

            RaycastHit raycastHit;
            if (Physics.Raycast(ray, out raycastHit))
            {
                _Destination = raycastHit.point;
            }
            else
            {
                _Destination = CalculateRayTargetXZ(ray, creaturePosition.y);
            }

            IsRunning =
                _Destination != null &amp;&amp;
                Vector3.Distance(creaturePosition, _Destination.Value) &gt;= _MinRunDistance;
        }
        else
        {
            IsRunning = false;
        }
    }

    public static Vector3? CalculateRayTargetXZ(Ray ray, float y = 0)
    {
        y = ray.origin.y - y;

        if (ray.direction.y == 0 || SameSign(y, ray.direction.y))
            return null;

        return ray.origin - ray.direction * (y / ray.direction.y);
    }

    public static bool SameSign(float x, float y)
    {
        return
            (x &gt; 0 &amp;&amp; y &gt; 0) ||
            (x &lt; 0 &amp;&amp; y &lt; 0) ||
            (x == 0 &amp;&amp; y == 0);
    }

    private void UpdateMovement()
    {
        if (_Destination != null)
        {
            var fromCurrentToDestination = _Destination.Value - Creature.Rigidbody.position;

            if (fromCurrentToDestination.sqrMagnitude &gt; _StopDistance * _StopDistance)
            {
                MovementDirection = fromCurrentToDestination;
                _Locomotion.TryEnterState();
                Debug.DrawLine(Creature.Rigidbody.position, _Destination.Value, Color.cyan);
                return;
            }
        }

        _Destination = null;
        MovementDirection = Vector3.zero;
        Creature.Idle.TryEnterState();
    }
}
</code></pre>
<p></p></details><p></p>
<h2 id="creature-brain-links">Creature-Brain Links</h2>
<p>Currently the references between the creature and brain (the <code>Creature.Brain</code> and <code>CreatureBrain.Creature</code> properties) are both read-only. We could just give them basic setters, but then anything changing them will need to handle disconnecting the previous references and connecting both of the new references (the new brain needs a reference to the creature and the creature needs a reference to that brain). It would be much better if we implemented the setters to take care of the cross-referencing for us:</p>
<p>So in <code>CreatureBrain</code> we change the <code>Creature</code> property to:</p>
<pre><code class="language-cs">public Creature Creature
{
    get { return _Creature; }
    set
    {
        if (_Creature == value)
            return;

        var oldCreature = _Creature;
        _Creature = value;

        // Make sure the old creature doesn't still reference this brain.
        if (oldCreature != null)
            oldCreature.Brain = null;

        // Give the new creature a reference to this brain.
        if (value != null)
            value.Brain = this;
    }
}
</code></pre>
<p>And in <code>Creature</code> we change the <code>Brain</code> property in the same way:</p>
<pre><code class="language-cs">public CreatureBrain Brain
{
    get { return _Brain; }
    set
    {
        if (_Brain == value)
            return;

        var oldBrain = _Brain;
        _Brain = value;

        // Make sure the old brain doesn't still reference this creature.
        if (oldBrain != null)
            oldBrain.Creature = null;

        // Give the new brain a reference to this creature.
        if (value != null)
            value.Creature = this;
    }
}
</code></pre>
<p>This allows either property to be set and it will disconnect the old creature and brain from each other then connect the new pair.</p>
<h2 id="setting-up-the-buttons">Setting Up the Buttons</h2>
<p>You would not generally have multiple brains on an object, but for the sake of this example the simplest way to set it up is to simply put both on the <em>Brain</em> object:</p>
<p><img src="dual-brain-inspector.png" class="img-responsive"></p>
<p>One should be enabled while the other is disabled. It doesn't really matter which is which, as long as the enabled one is also assigned to the <em>Creature</em>'s <code>Brain</code> field.</p>
<p>Then we can set up the button clicks to perform the disable old brain -&gt; set brain -&gt; enable new brain operations:</p>
<table class="table">
  <thead><tr>
    <th style="width:50%;">Keyboard Button</th>
    <th style="width:50%;">Mouse Button</th>
  </tr></thead>
  
  <tbody>
  <tr>
    <td><p><img src="keyboard-button.png" class="img-responsive"></p></td>
    <td><p><img src="mouse-button.png" class="img-responsive"></p></td>
  </tr>
  </tbody>
</table>
<p>Now we can swap brains whenever we want:</p>
<p><img src="brain-transplant.gif" class="img-responsive"></p>

	</section>
                
            </div>           
            
            <!-- Footer -->
            <footer class="main-footer">
            </footer>
            
        </div>
        <div class="wrapper bottom-wrapper">
            <footer class="bottom-footer">
                Generated by <a href="https://wyam.io">Wyam</a>
            </footer>
        </div>
        <a href="javascript:" id="return-to-top"><i class="fa fa-chevron-up"></i></a>
        
        <script>           
            // Close the sidebar if we select an anchor link
            $(".main-sidebar a[href^='#']:not('.expand')").click(function(){
                $(document.body).removeClass('sidebar-open');
            });
            
            $(document).ready(function() {
                mermaid.initialize(
                {
                    flowchart:
                    {
                        useMaxWidth: false
                    },
					startOnLoad: false,
					cloneCssStyles: false
                });     
                mermaid.init(undefined, ".mermaid");

                // Remove the max-width setting that Mermaid sets
                var mermaidSvg = $('.mermaid svg');
                mermaidSvg.addClass('img-responsive');
                mermaidSvg.css('max-width', '');

                // Make it scrollable
				var target = document.querySelector(".mermaid svg");
				if(target !== null)
				{
					var panZoom = window.panZoom = svgPanZoom(target, {
						zoomEnabled: true,
						controlIconsEnabled: true,
						fit: true,
						center: true,
                        maxZoom: 20,
                        zoomScaleSensitivity: 0.6
					});			                          

                    // Do the reset once right away to fit the diagram
                    panZoom.resize();
                    panZoom.fit();
                    panZoom.center();
                    
                    $(window).resize(function(){
                        panZoom.resize();
                        panZoom.fit();
                        panZoom.center();
                    });
				}
                
                $('pre code').each(function(i, block) {
                    hljs.highlightBlock(block);
                });  
            });

            hljs.initHighlightingOnLoad();

            // Back to top
            $(window).scroll(function() {
                if ($(this).scrollTop() >= 200) {        // If page is scrolled more than 50px
                    $('#return-to-top').fadeIn(1000);    // Fade in the arrow
                } else {
                    $('#return-to-top').fadeOut(1000);   // Else fade out the arrow
                }
            });
            $('#return-to-top').click(function() {      // When arrow is clicked
                $('body,html').animate({
                    scrollTop : 0                       // Scroll to top of body
                }, 500);
            });
        </script>
    
</body></html>